<!DOCTYPE html>
<html>

<head>
    <script src="ClientGlobalContext.js.aspx"></script>
    <script src="im360_common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/jquery@3.1.1/dist/jquery.js"></script>
    <script src="https://unpkg.com/vue-select@3.0.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/vue-select@3.0.0/dist/vue-select.css">

    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.2.0/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui@2.2.0/lib/index.js"></script>

</head>

<body>
    <div id="app">
        <div v-if="showLoading" id="loading">
            <div id="loading-content">
                <img src="im360_Loading.gif" />
            </div>
        </div>

        <div>
            <div class="select-box">
                <v-select ref="mySelect" v-model="selectedIdAndSubject" @input="setSelected" placeholder="Select ticket" @new="addOption"
                          :options="selectOptions" />
            </div>

            <div v-if="notFoundMessage" class="not-found">
                {{notFoundMessage}}
            </div>

            <div v-if="record && record.id">
                <div id="viewerHead">
                    <h3>#{{record.id}} {{record.subject}}</h3>
                    <p v-if="record.company && record.company.name">
                        <strong class="boldCompany">Company</strong>
                        <a class="underlined"
                           @click="companyTickets(record.company_id, record.company.name)">{{record.company.name}}</a>
                    </p>

                    <div v-if="record.created_at" class="recordTags">
                        <strong class="boldDue">Date created:  </strong>
                        {{record.created_at.substring(0, 10)}}
                        
                    </div>

                    <div v-if="record.requesterEmail" class="recordTags">
                        <strong class="boldRequester">Partner email address:</strong>
                        {{record.requesterEmail}}
                    </div>
                    
                   <table v-if="record && record.custom_fields" aria-describedby="ticketDetails" class="details">
                        <tr>
                            <th id="1">Agent</th>
                            <th id="2" class="min-col-bcn">Ingram BCN#</th>
                            <th id="3">Customer ID</th>
                            <th id="4">Subscription ID</th>
                            <th id="5">Domain</th>
                            <th id="6">Support tier</th>
                            <th id="7">Platform</th>
                            <th id="8">Vendor</th>
                            <th id="9">Country</th>
                            <th id="10">Status</th>
                            <th id="11">Priority</th>
                            <th id="12">Jira ticket ID</th>
                            <th id="13">IMServ ticket ID </th>
                        </tr>
                        <tr>
                            <td>{{record.strAgent ? record.strAgent : '-'}}</td>
                            <td>{{record.zendeskBCN ? record.zendeskBCN : '-'}}</td>
                            <td>{{isStage ? record.custom_fields.find(f => f.id === 34395814674196) && record.custom_fields.find(f => f.id === 34395814674196).value ? record.custom_fields.find(f => f.id === 34395814674196) && record.custom_fields.find(f => f.id === 34395814674196).value : '-' 
                                : record.custom_fields.find(f => f.id === 34691185003796) && record.custom_fields.find(f => f.id === 34691185003796).value ? record.custom_fields.find(f => f.id === 34691185003796) && record.custom_fields.find(f => f.id === 34691185003796).value : '-'}}</td>
                            <td>{{isStage ? record.custom_fields.find(f => f.id === 21077955613972) && record.custom_fields.find(f => f.id === 21077955613972).value ? record.custom_fields.find(f => f.id === 21077955613972) && record.custom_fields.find(f => f.id === 21077955613972).value : '-'
                                : record.custom_fields.find(f => f.id === 20780455543956) && record.custom_fields.find(f => f.id === 20780455543956).value ? record.custom_fields.find(f => f.id === 20780455543956) && record.custom_fields.find(f => f.id === 20780455543956).value : '-'}}</td>
                            <td>{{record.strDomain ? record.strDomain : '-'}}</td>
                            <td>{{record.strSupportTier ? record.strSupportTier : '-'}}</td>
                            <td>{{record.strPlatform ? record.strPlatform : '-'}}</td>
                            <td>{{record.strVendor ? record.strVendor : '-'}}</td>
                            <td>{{record.strCountry ? record.strCountry : '-'}}</td>
                            <td>{{record.status ? record.status.charAt(0).toUpperCase() + record.status.slice(1) : '-'}}</td>
                            <td>{{record.priority ? record.priority.charAt(0).toUpperCase() + record.priority.slice(1) : '-'}}</td>
                            <td>{{isStage ? record.custom_fields.find(f => f.id === 33478946088596) && record.custom_fields.find(f => f.id === 33478946088596).value ? record.custom_fields.find(f => f.id === 33478946088596) && record.custom_fields.find(f => f.id === 33478946088596).value : '-'
                                : record.custom_fields.find(f => f.id === 35113832690964) && record.custom_fields.find(f => f.id === 35113832690964).value ? record.custom_fields.find(f => f.id === 35113832690964) && record.custom_fields.find(f => f.id === 35113832690964).value : '-'}}</td>
                            <td>{{isStage ? record.custom_fields.find(f => f.id === 33478981057940) && record.custom_fields.find(f => f.id === 33478981057940).value ? record.custom_fields.find(f => f.id === 33478981057940) && record.custom_fields.find(f => f.id === 33478981057940).value : '-'
                                : record.custom_fields.find(f => f.id === 34693101133716) && record.custom_fields.find(f => f.id === 34693101133716).value ? record.custom_fields.find(f => f.id === 34693101133716) && record.custom_fields.find(f => f.id === 34693101133716).value : '-'}}</td>
                        </tr>
                    </table>
                    <br>
                </div>

            </div>

            <div v-if="record && record.id" class="conversation">
                <div v-if="record.conversations && record.conversations[0]">
                    <ul>
                        <li v-for="item in record.conversations" :key="item.id">
                            <div :style="{ backgroundColor: item.dynamicColor }" class="MainMessageConversation">
                                <strong class="MessageHeader">{{item.created_at && item.created_at.length > 10 ? item.created_at.substring(0, 10) : ''}} {{item.created_at && item.created_at.length > 19 ? item.created_at.substring(11, 19) : ''}} -
                                    From: {{item.author_email || record.requesterEmail}}</strong>
                                <div style="margin-left: 20px;" v-html="item.html_body"></div>
                                <div style="margin-left: 20px;" v-if="item.attachments && item.attachments[0]">
                                    <strong>Attachments:</strong>
                                    <ul>
                                        <li v-for="attach in item.attachments" :key="attach.file_name">
                                            <a :href="attach.content_url" target="_blank">{{attach.file_name}}</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <div v-if="!notFoundMessage" class="collapse-ticket-summary">
                <el-row>
                    <el-collapse>
                        <el-collapse accordion>
                            <el-collapse-item>
                                <template slot="title">
                                    Summary Of Tickets
                                    <el-button class="more-btn" type="text">Expand / Collapse</el-button>
                                </template>

                                <div>
                                    Total tickets group by month:
                                </div>
                                <div style="margin-left: 20px;" v-html="groupByMonthTickets"></div>
                            </el-collapse-item>
                        </el-collapse>
                </el-row>
            </div>

        </div>
    </div>

    <script>
        let isStage = true;
        let Global_im360_armid = '';               // CMP ID
        let Global_ZendeskBCN = '';                // use this BCN for the ticket search by ticket id (it should come from the Zendesk ticket, not from the Account itself)
        let Global_zendesk_ticketIdParam = '';
        let Global_appId = '';
        let Global_dashboardId = '';
        let Global_originalResellerCountry = '';
        let Global_originalResellerBCN = '';
        let Global_originalResellerCMPID = '';

        let Global_country_name = '';
        let Global_im360_bcn = '';

        function setClientApiContext(Xrm, context, accountBCN, newnavigationtab) {
            var pageTitle = 'Zendesk';
            console.log(`${pageTitle} - setClientApiContext started...`);
            
            if (newnavigationtab) {
                console.log(`${pageTitle} - newnavigationtab: ${newnavigationtab.toString()}`);
            } else {
                console.log(`${pageTitle} - newnavigationtab is null`);
            }

            /* newnavigationtab example: "tab_freshdesk_31105_20666904" */
            if (newnavigationtab && newnavigationtab.toString().startsWith('tab_freshdesk')) { 
                var paramsFromExtraqs = newnavigationtab.toString().split('_');
                console.log(`${pageTitle} - paramsFromExtraqs: ${paramsFromExtraqs.join(',')}`);
                Global_zendesk_ticketIdParam = paramsFromExtraqs[2];
                console.log(`${pageTitle} - ticketIdParam: ${Global_zendesk_ticketIdParam}`);
            }
        };

        let items = [];
        let record = {};

        Vue.component('v-select', VueSelect.VueSelect);

        let app = new Vue({
            el: '#app',
            data: {
                pageTitle: 'Zendesk',
                zendeskBaseUrl: '',
                funcCode: '',
                funcCodeForComments: '',
                funcCodeForTickets: '',
                funcCodeForJsonById: '',
                selectedIdAndSubject: '',
                selectOptions: ['View more tickets...'],
                record: null,
                items: null,
                showLoading: true,
                startTime: Date.now(),
                notFoundMessage: '',
                ticketSummary: [],
                groupByMonthTickets: '',
                groupByQueueTickets: '',
                inputTicketId: '',
            },
            async mounted() {
                let userSettings = Xrm && Xrm.Utility && Xrm.Utility.getGlobalContext() && Xrm.Utility.getGlobalContext().userSettings;
                let userName = userSettings && userSettings.userName;
                //let userRoles = userSettings && userSettings.securityRoles && userSettings.securityRoles.toLowerCase();
                console.log(`${this.pageTitle} - signed in user name is: ${userName}`);

                // Wait for vue-select to render, then attach key listener
                this.$nextTick(() => {
                    const inputEl = this.$refs.mySelect.$el.querySelector('input');
                    if (inputEl) {
                        inputEl.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                this.handleEnter(e);
                            }
                        });
                    }
                });
                // if (!Global_country_name || !Global_im360_bcn){
                    let account = await this.getAccountCountryAndBCN();
                    if (account) {
                        Global_country_name = account.CountryName;
                        Global_im360_bcn = account.im360_bcn;
                        Global_im360_armid = account.im360_armid;
                        // replace all single quote with empty string, for example: {'1000003522'}
                        Global_im360_armid = Global_im360_armid ? Global_im360_armid.replace(/'/g, "") : '';
                        Global_originalResellerCountry = Global_country_name;
                        Global_originalResellerBCN = Global_im360_bcn;
                        Global_originalResellerCMPID = Global_im360_armid;
                    } else {
                        console.error(`${this.pageTitle} - account is null in mounted()`);
                    }
                // }
                console.log(`${this.pageTitle} - Global_country_name value in mounted(): ${Global_country_name}`);
                console.log(`${this.pageTitle} - Global_im360_bcn value in mounted(): ${Global_im360_bcn}`);
                console.log(`${this.pageTitle} - Global_im360_armid value in mounted(): ${Global_im360_armid}`);
                this.showLoadingPage && this.showLoadingPage();
                this.startTime = Date.now();

                let funcCodeString = '';
                let zendeskConfig = await this.getZendeskConfig();
                if (zendeskConfig) {
                    this.zendeskBaseUrl = zendeskConfig.im360_value;
                    funcCodeString = zendeskConfig.im360_value2;
                    this.Global_appId = zendeskConfig.im360_value3;
                    console.log(`${this.pageTitle} - Global_appId from FreshdeskAPI configuration: ${this.Global_appId}`);
                } else {
                    console.error(`${this.pageTitle} - zendeskConfig is null`);
                    this.hideLoadingPage && this.hideLoadingPage();
                }
                console.log(`${this.pageTitle} - try to start getTickets function`);

                let zendeskBaseUrl = this.zendeskBaseUrl;
                let apiProd = 'crm-zendesk-api-prod';
                if (zendeskBaseUrl && zendeskBaseUrl.indexOf(apiProd) > -1) {
                    isStage = false;
                } else {
                    isStage = true;
                }
                let funcCodeArr = funcCodeString.toString().split(';;;;');
                let funcCodeForTickets = funcCodeArr.length > 2 && funcCodeArr[2];
                let funcCode = funcCodeArr.length > 0 && funcCodeArr[0];
                let funcCodeForComments = funcCodeArr.length > 1 && funcCodeArr[1];
                let funcCodeForJsonById = funcCodeArr.length > 3 && funcCodeArr[3];
                this.Global_dashboardId = funcCodeArr.length > 4 && funcCodeArr[4];
                console.log(`${this.pageTitle} - Global_dashboardId from FreshdeskAPI configuration: ${this.Global_dashboardId}`);
                this.funcCodeForComments = funcCodeForComments;
                this.funcCodeForTickets = funcCodeForTickets;
                this.funcCode = funcCode;
                this.funcCodeForJsonById = funcCodeForJsonById;

                // await new Promise(resolve => setTimeout(resolve, 2000)); // wait 2 seconds to ensure Global_zendesk_ticketIdParam variables are set
                console.log(`${this.pageTitle} - Global_zendesk_ticketIdParam: ${Global_zendesk_ticketIdParam}`);

                let selectedTicketId = localStorage.getItem('zendesk_ticketId');
                console.log(`${this.pageTitle} - selectedTicketId from localStorage: ${selectedTicketId}`);
                
                if (Global_zendesk_ticketIdParam) {
                    selectedTicketId = Global_zendesk_ticketIdParam;
                }

                if (this.zendeskBaseUrl && Global_country_name && Global_im360_bcn) {
                    let tickets = await  this.getTickets(selectedTicketId, this.showLoadingPage, this.hideLoadingPage);
                    if (tickets) {
                        // Question: is it possible for the ticketId to be null if the "tickets" is not null? - it's not possible
                        const {selected, selectOptions, items} = tickets;
                        this.selected = selected;
                        this.selectOptions = selectOptions;
                        this.items = items;
                        let ticketId = getTicketId(selected);

                        let userSettings = Xrm && Xrm.Utility && Xrm.Utility.getGlobalContext() && Xrm.Utility.getGlobalContext().userSettings;
                        let userName = userSettings && userSettings.userName;

                        let ticketIdForAPI = ticketId;
                        // if the ticket is not synced from Zendesk to IM360, need to retrieve it from Zendesk:
                        if (selectedTicketId && (ticketId != selectedTicketId)) {
                            console.log(`Zendesk - ticket id from IM360 is: ${ticketId}, but the ticket id from localStorage is: ${selectedTicketId}`);
                            ticketIdForAPI = selectedTicketId;
                        }
                        
                        this.showLoadingPage && this.showLoadingPage();
                        this.record = await this.getTicket(this.zendeskBaseUrl, this.funcCode, ticketIdForAPI, userName, this.showLoadingPage, this.hideLoadingPage, 
                                this.getZendeskConfigNameByValue, this.getZendeskConfigEmailByKey, this.getZendeskConfigRoleByKey, this.getZendeskConfigNameByKey);
                        this.hideLoadingPage && this.hideLoadingPage();

                        if (this.record && this.record.error === 'RecordNotFound') {
                            this.notFoundMessage = `Ticket ID ${ticketIdForAPI} was not found in Zendesk, the cached data could be outdated. Please select another ticket or try again later.`;
                            console.error(`${this.pageTitle} - ${this.notFoundMessage}`);
                            // the selected ticket should not be empty when the user open the page first time:
                            if (!this.selectedIdAndSubject && this.selectOptions && this.selectOptions.length > 0) {
                                this.selectedIdAndSubject = this.selectOptions[0];
                            }
                            this.record = null;
                            return;
                        }

                        if (selectedTicketId && (ticketId != selectedTicketId)) {
                            let idAndSubject = `${selectedTicketId}.${(this.record && this.record.subject) ?? '-'}`;
                            if (!this.selectOptions.includes(idAndSubject)) {
                                this.selectOptions.unshift(idAndSubject);  // add ticketId and subject as the first item of the array
                            }
                            // don't need to "check if the ticket id belong to this reseller"
                        } 
                        
                        let id = this.record && this.record['id'];
                        let subjectGet = this.record && this.record['subject'];
                        this.selectedIdAndSubject = id && subjectGet ? `${id}.${subjectGet}` : `${id}.-`;
                        
                        if (items && items.length > 0) {
                            this.ticketSummary = this.getTicketSummary(items);
                            if (this.ticketSummary.length > 0) {
                                this.groupByMonthTickets = this.getGroupByMonthTickets(this.ticketSummary);
                            }
                        }
                    }
                } else {
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    console.log(`${this.pageTitle} - try again - Global_country_name: ${Global_country_name}`);
                    console.log(`${this.pageTitle} - try again - Global_im360_bcn: ${Global_im360_bcn}`);
                    let message = 'try to start getTickets function for the second time';
                    console.log(`${this.pageTitle} - ${message}. ZendeskBaseUrl: ${this.zendeskBaseUrl}`);
                    if (Global_country_name && Global_im360_bcn) {
                        this.notFoundMessage = '';
                        let tickets = await  this.getTickets(selectedTicketId, this.showLoadingPage, this.hideLoadingPage);
                        if (tickets) {
                            const {selected, selectOptions, items} = tickets;
                            this.selected = selected;
                            this.selectOptions = selectOptions;
                            this.items = items;
                            let ticketId = getTicketId(selected);
                            this.record = await this.getTicket(zendeskBaseUrl, funcCode, ticketId, userName, this.showLoadingPage, this.hideLoadingPage, 
                                this.getZendeskConfigNameByValue, this.getZendeskConfigEmailByKey, this.getZendeskConfigRoleByKey, this.getZendeskConfigNameByKey);
                            if (this.record && this.record.error === 'RecordNotFound') {
                                this.notFoundMessage = `Tried again, but the ticket id ${selectedTicketId} still not found from Zendesk API.`;
                                this.record = null;
                                this.hideLoadingPage && this.hideLoadingPage();
                                return;
                            }
                            let id = this.record && this.record['id'];
                            let subjectGet = this.record && this.record['subject'];
                            this.selectedIdAndSubject = id && subjectGet ? `${id}.${subjectGet}` : `${id}.-`;
                            if (items && items.length > 0) {
                                this.ticketSummary = this.getTicketSummary(items);
                                if (this.ticketSummary.length > 0) {
                                    this.groupByMonthTickets = this.getGroupByMonthTickets(this.ticketSummary);
                                }
                            }
                        }
                    } else {
                        this.notFoundMessage = "Account Country and BCN are required to find related tickets.";
                        this.hideLoadingPage && this.hideLoadingPage();
                    }
                }

                localStorage.setItem('zendesk_ticketId', '');   // TODO: confirm if this is the best place to put this line

            },
            methods: {
                async getZendeskConfig() {
                    let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                         <entity name='im360_configuration'> \
                             <attribute name='im360_configurationid'/> \
                             <attribute name='im360_value'/> \
                             <attribute name='im360_value2'/> \
                             <attribute name='im360_value3'/> \
                             <attribute name='im360_value4'/> \
                             <filter type='and'> \
                                 <condition attribute='im360_name' operator='eq' value='FreshdeskAPI' /> \
                                 <condition attribute='statuscode' operator='eq' value='1' /> \
                             </filter> \
                         </entity> \
                         </fetch>";

                    let pageTitle = this.pageTitle;
                    return Xrm.WebApi.retrieveMultipleRecords("im360_configuration", "?fetchXml=" + fetchXml).then(
                        function success(result) {
                            if (result != null) {
                                return result.entities[0];
                            } else {
                                console.error(`${pageTitle} - Cannot get Zendesk configuration, the fetchXml is: ${fetchXml}`);
                                return null;
                            }
                        },
                        function (error) {
                            console.error(`${pageTitle} - ${error.message}`);
                            this.hideLoadingPage && this.hideLoadingPage();
                            return null;
                        }
                    );
                },

                async getAccountCountryAndBCN() {
                    let accountid = this.getValueParam();
                    if (accountid) {
                        let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                            <entity name='account'> \
                                <attribute name='im360_bcn' /> \
                                <attribute name='im360_armid' /> \
                                <link-entity name='im360_country' from='im360_countryid' to='im360_country' link-type='inner'> \
                                    <attribute name='im360_name' alias='CountryName' /> \
                                </link-entity> \
                                <filter type='and'> \
                                    <condition attribute='accountid' operator='eq' value='" + accountid + "' /> \
                                </filter> \
                            </entity> \
                            </fetch>";

                        let pageTitle = this.pageTitle;
                        return Xrm.WebApi.retrieveMultipleRecords("account", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null) {
                                    return result.entities[0];
                                } else {
                                    console.error(`${pageTitle} - Cannot get Account BCN, the fetchXml is: ${fetchXml}`);
                                    return null;
                                }
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                this.hideLoadingPage && this.hideLoadingPage();
                                return null;
                            }
                        );
                    } else{
                        return null;
                    }
                },

                async getZendeskConfigNameByKey(configKey) {
                    let configName = '';
                    if (!configKey) {
                        return configName;
                    }
                    if (configKey) {
                        let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                            <entity name='im360_zendeskconfig'> \
                                <attribute name='im360_description' /> \
                                <filter type='and'> \
                                    <condition attribute='im360_key' operator='eq' value='" + configKey + "' /> \
                                    <condition attribute='im360_category' operator='eq' value='users' /> \
                                </filter> \
                            </entity> \
                            </fetch>";

                        let pageTitle = this.pageTitle;
                        return Xrm.WebApi.retrieveMultipleRecords("im360_zendeskconfig", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null && result.entities && result.entities.length > 0) {
                                    let zendeskConfig = result.entities[0];
                                    if (zendeskConfig) {
                                        configName = zendeskConfig.im360_description;
                                    }

                                } else {
                                    console.log(`${pageTitle} - Cannot get Zendesk Config User Name by Key, will get it from Zendesk API, the fetchXml is: ${fetchXml}`);
                                    configName = null;
                                }
                                return configName;
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                this.hideLoadingPage && this.hideLoadingPage();
                                return null;
                            }
                        );
                    } else{
                        return null;
                    }
                },

                async getZendeskConfigRoleByKey(configKey) {
                    let configValue = '';
                    if (!configKey) {
                        return configValue;
                    }
                    if (configKey) {
                        let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                            <entity name='im360_zendeskconfig'> \
                                <attribute name='im360_value' /> \
                                <filter type='and'> \
                                    <condition attribute='im360_key' operator='eq' value='" + configKey + "' /> \
                                    <condition attribute='im360_category' operator='eq' value='users' /> \
                                </filter> \
                            </entity> \
                            </fetch>";

                        let pageTitle = this.pageTitle;
                        return Xrm.WebApi.retrieveMultipleRecords("im360_zendeskconfig", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null && result.entities && result.entities.length > 0) {
                                    let zendeskConfig = result.entities[0];
                                    if (zendeskConfig) {
                                        configValue = zendeskConfig.im360_value;
                                    }

                                } else {
                                    console.log(`${pageTitle} - Cannot get Zendesk Config User Role by Key, will get it from Zendesk API, the fetchXml is: ${fetchXml}`);
                                    configValue = null;
                                }
                                return configValue;
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                this.hideLoadingPage && this.hideLoadingPage();
                                return null;
                            }
                        );
                    } else{
                        return null;
                    }
                },

                async getZendeskConfigEmailByKey(configKey) {
                    let configName = '';
                    if (!configKey) {
                        return configName;
                    }
                    if (configKey) {
                        let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                            <entity name='im360_zendeskconfig'> \
                                <attribute name='im360_name' /> \
                                <filter type='and'> \
                                    <condition attribute='im360_key' operator='eq' value='" + configKey + "' /> \
                                    <condition attribute='im360_category' operator='eq' value='users' /> \
                                </filter> \
                            </entity> \
                            </fetch>";

                        let pageTitle = this.pageTitle;
                        return Xrm.WebApi.retrieveMultipleRecords("im360_zendeskconfig", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null && result.entities && result.entities.length > 0) {
                                    let zendeskConfig = result.entities[0];
                                    if (zendeskConfig) {
                                        configName = zendeskConfig.im360_name;
                                    }

                                } else {
                                    console.log(`${pageTitle} - Cannot get Zendesk Config User Email by Key, will get it from Zendesk API, the fetchXml is: ${fetchXml}`);
                                    configName = null;
                                }
                                return configName;
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                this.hideLoadingPage && this.hideLoadingPage();
                                return null;
                            }
                        );
                    } else{
                        return null;
                    }
                },

                async getZendeskConfigNameByValue(configValue) {
                    let configName = '';
                    if (!configValue) {
                        return configName;
                    }
                    if (configValue) {
                        let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                            <entity name='im360_zendeskconfig'> \
                                <attribute name='im360_name' /> \
                                <filter type='and'> \
                                    <condition attribute='im360_value' operator='eq' value='" + configValue + "' /> \
                                    <condition attribute='im360_category' operator='eq' value='ticket_fields' /> \
                                </filter> \
                            </entity> \
                            </fetch>";

                        let pageTitle = this.pageTitle;
                        return Xrm.WebApi.retrieveMultipleRecords("im360_zendeskconfig", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null && result.entities && result.entities.length > 0) {
                                    let zendeskConfig = result.entities[0];
                                    if (zendeskConfig) {
                                        configName = zendeskConfig.im360_name;
                                    }

                                } else {
                                    console.log(`${pageTitle} - Cannot get Zendesk Config Name by Value, will get it from Zendesk API, the fetchXml is: ${fetchXml}`);
                                    configName = null;
                                }
                                return configName;
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                this.hideLoadingPage && this.hideLoadingPage();
                                return null;
                            }
                        );
                    } else{
                        return null;
                    }
                },

                getValueParam() {
                    let valueId = '';
                    let vals = new Array();
                    if (location.search != "") {
                        vals = location.search.substr(1).split("&");
                        for (let i in vals) {
                            vals[i] = vals[i].replace(/\+/g, " ").split("=");
                            if (vals[i][0].includes("id", 0)) {
                                valueId = vals[i][1];
                                valueId = valueId.replace('{', '').replace('}', '');
                            }
                        }
                    }
                    if (valueId.length > 36) valueId = valueId.substr(3, 36);
                    return valueId;
                },

                async getTickets(selectedTicketId, showLoadingPage, hideLoadingPage) {
                    let results = [];

                    // IM360 BCN must exist, it's from the account record:
                    if (Global_im360_bcn && Global_im360_bcn.length > 0) {
                        let filterOrForBCN = `<condition attribute='im360_ingrambcn' operator='like' value='%${Global_im360_bcn}%' />`;
                        // add "-" after the second digits, for example: "41389412" -> "41-389412"
                        if (Global_im360_bcn.length > 2) {
                            let bcnWithDash = Global_im360_bcn.slice(0, 2) + "-" + Global_im360_bcn.slice(2);
                            filterOrForBCN += `<condition attribute='im360_ingrambcn' operator='like' value='%${bcnWithDash}%' />`;
                        }
                        if (Global_im360_armid && Global_im360_armid.length > 0) {
                            filterOrForBCN += `<condition attribute='im360_ingrambcn' operator='like' value='%${Global_im360_armid}%' />`;
                            if (Global_im360_armid.length > 2) {
                                // IM360 CMP ID possible value (with single quote): '1000003522'
                                let cmpIdWithoutSingleQuote = Global_im360_armid.replace(/'/g, "");
                                filterOrForBCN += `<condition attribute='im360_ingrambcn' operator='like' value='%${cmpIdWithoutSingleQuote}%' />`;

                                // add "-" after the second digits, for example: "1000003522" -> "10-00003522"
                                let cmpWithDash = cmpIdWithoutSingleQuote.slice(0, 2) + "-" + cmpIdWithoutSingleQuote.slice(2);
                                filterOrForBCN += `<condition attribute='im360_ingrambcn' operator='like' value='%${cmpWithDash}%' />`;
                            }
                        }

                        let fetchXml = `<fetch top='5000'> \
                                            <entity name='im360_zendesktickets'> \
                                                <attribute name='im360_accountid' /> \
                                                <attribute name='im360_country' /> \
                                                <attribute name='im360_created_at' /> \
                                                <attribute name='im360_domain' /> \
                                                <attribute name='im360_ingrambcn' /> \
                                                <attribute name='im360_partneremailaddress' /> \
                                                <attribute name='im360_priority' /> \
                                                <attribute name='im360_resellername' /> \
                                                <attribute name='im360_resolved_at' /> \
                                                <attribute name='im360_resolvehours' /> \
                                                <attribute name='im360_status' /> \
                                                <attribute name='im360_ticketid' /> \
                                                <attribute name='im360_name' /> \
                                                <attribute name='im360_updated_at' /> \
                                                    <filter type='and'> \
                                                        <condition attribute='im360_country' operator='eq' value='${Global_country_name}' /> \
                                                        <condition attribute='im360_ingrambcn' operator='ne' value='Review and Update (Do Not Use)' /> \
                                                        <condition attribute='im360_ingrambcn' operator='ne' value='na' /> \
                                                        <condition attribute='im360_ingrambcn' operator='ne' value='NA' /> \
                                                        <condition attribute='im360_ingrambcn' operator='ne' value='.' /> \
                                                        <condition attribute='im360_ingrambcn' operator='ne' value='x' /> \
                                                        <condition attribute='im360_ingrambcn' operator='not-null'  /> \
                                                        <filter type='or'> ${filterOrForBCN} </filter> \
                                                        <condition attribute='im360_domain' operator='ne' value='Sales Esc (Legacy)' /> \
                                                        <condition attribute='im360_domain' operator='ne' value='Sales Esc�(Legacy)' /> \
                                                        <condition attribute='im360_domain' operator='ne' value='MS Escalations (Legacy)' /> \
                                                    </filter> \
                                                <order descending='true' attribute='im360_created_at' /> \
                                            </entity> \
                                        </fetch>`;

                        let pageTitle = this.pageTitle;
                        let selectOptions = this.selectOptions;
                        showLoadingPage && showLoadingPage();
                        this.showLoadingPage && this.showLoadingPage();
                        
                        return Xrm.WebApi.retrieveMultipleRecords("im360_zendesktickets", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                let selected = '';
                                let items = [];
                                let filteredItems = [];

                                if (result != null) {
                                    items = result.entities;

                                    const filteredItemsBCN = filterExactBCNResults(items, Global_im360_bcn);
                                    const filteredItemsCMPID = filterExactBCNResults(items, Global_im360_armid);
                                    const combinedItems = [...filteredItemsBCN, ...filteredItemsCMPID];

                                    // Remove duplicates based on 'im360_ticketid'
                                    filteredItems = combinedItems.filter((item, index, self) =>
                                        index === self.findIndex((t) => t.im360_ticketid === item.im360_ticketid)
                                    );

                                    if (filteredItems && filteredItems.length > 0) {
                                        selected = `${filteredItems[0]['im360_ticketid']}.${filteredItems[0]['im360_name']}`;
                                        if (selectedTicketId) {
                                            filteredItems.forEach(item => {
                                                if(item['im360_ticketid'] && (item['im360_ticketid'].toString() == selectedTicketId)) {
                                                    selected = `${item['im360_ticketid']}.${item['im360_name']}`;
                                                }
                                            });
                                        }

                                        selectOptions = [];
                                        filteredItems.forEach(item => {
                                            selectOptions.push(`${item.im360_ticketid}.${item.im360_name}`);
                                        });
                                        if (selectOptions.length > 0) {
                                            let newOption = 'View more tickets...';
                                            if (!selectOptions.includes(newOption)) {
                                                selectOptions.push(newOption);
                                            }
                                        }
                                    }
                                } else {
                                    console.error(`${pageTitle} - Cannot get Zendesk tickets, the fetchXml is: ${fetchXml}`);
                                    return null;
                                }

                                let finalResult = {
                                    selected,
                                    selectOptions,
                                    items: filteredItems
                                }
                                hideLoadingPage && hideLoadingPage();
                                this.hideLoadingPage && this.hideLoadingPage();
                                return finalResult;
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                hideLoadingPage && hideLoadingPage();
                                this.hideLoadingPage && this.hideLoadingPage();
                                return null;
                            }
                        );
                    }
                    return results;
                },

                async setSelected() {
                    if (this.selectedIdAndSubject === 'View more tickets...') {
                        this.showLoadingPage && this.showLoadingPage();
                        // refresh:
                        // this.getTickets(this.zendeskBaseUrl, this.funcCode, this.funcCodeForTickets, '', 100, this.hideLoadingPage);
                        let url = window.location.protocol + "//" + window.location.host + "/";
                        let fullUrl = `${url}/main.aspx?appid=${this.Global_appId}&pagetype=dashboard&id=${this.Global_dashboardId}&type=system`;
                        console.log(`${this.pageTitle} - fullUrl: ${fullUrl}`);

                        localStorage.setItem('zendesk_country_name', Global_country_name);
                        localStorage.setItem('zendesk_im360_bcn', Global_im360_bcn);
                        localStorage.setItem('zendesk_im360_armid', Global_im360_armid);

                        await new Promise(resolve => setTimeout(resolve, 1000)); // wait 1 second to ensure the localStorage variables are updated
                        
                        //let bcn = Global_ZendeskBCN ? Global_ZendeskBCN : this.Global_ZendeskBCN;
                        // let zendeskBcn = Global_ZendeskBCN ? Global_ZendeskBCN : this.Global_ZendeskBCN;
                        // if (bcn && bcn.indexOf('|') > 0) {
                        //     bcn = bcn.split("|")[1].trim();
                        // }

                        // BCN logic (don't need the following code, just save the original BCN string from Zendesk, then process it in dashboard page)
                        // let bcn = '';
                        // let bcnFilters = '';
                        // if (!zendeskBcn || zendeskBcn.toLowerCase() === 'na' || zendeskBcn === '.' || zendeskBcn.toLowerCase() === 'x') {
                        //     bcnFilters = '';
                        // } else {
                        //     const defaultFilter = `<condition attribute='im360_bcn' operator='eq' value='${zendeskBcn}' />`;
                        //     bcnFilters += defaultFilter;

                        //     const validBcn = zendeskBcn.replace(/-/g, "");
                        //     const numbersStrArr = validBcn.match(/\d+/g) || [];
                        //     numbersStrArr.forEach(bcnItem => {
                        //         let possibleBCN = bcnItem.toString();
                        //         let possibleFilter = `<condition attribute='im360_bcn' operator='eq' value='${possibleBCN}' />`;
                        //         bcnFilters += possibleFilter;
                        //     });
                        // }

                        /* possible BCN value: 
                            50-179892
                            1000008496 | 41880071 | 3002576
                            1000009207 (50708711)
                            1200135560	/ 384738 BERT ROLSTON
                            1200002059 / 178007	Troppus IT & Management (WA)
                            17-178742, 17-178802, 17-178812, 17-178832
                            14-281043 MERCHANT EXPO
                            .IRG PLOTTERS & PRINTERS INC 14-686831
                            Advanced Network Management Inc - Account 20-125586
                            .14-852252
                            308743 / 1200085322 BUSINESS IT SOUTH LIMITED
                            1300062325/AERUMA GROUP SDN BHD
                            "na", "NA"
                        */

                        this.hideLoadingPage && this.hideLoadingPage();

                        if (this.record) {
                            let id = this.record && this.record['im360_ticketid'] || this.record && this.record['id'];
                            let subjectGet = this.record && this.record['im360_name'] || this.record && this.record['subject'];
                            this.selectedIdAndSubject = `${id}.${subjectGet}`;
                        } else {
                            this.selectedIdAndSubject = '';
                        }

                        window.open(fullUrl, '_blank');
                        return;
                    } else {
                        this.showLoadingPage && this.showLoadingPage();
                        const ticketId = getTicketId(this.selectedIdAndSubject);

                        let userSettings = Xrm && Xrm.Utility && Xrm.Utility.getGlobalContext() && Xrm.Utility.getGlobalContext().userSettings;
                        let userName = userSettings && userSettings.userName;
                        this.record = await this.getTicket(this.zendeskBaseUrl, this.funcCode, ticketId, userName, this.showLoadingPage, this.hideLoadingPage, 
                            this.getZendeskConfigNameByValue, this.getZendeskConfigEmailByKey, this.getZendeskConfigRoleByKey, this.getZendeskConfigNameByKey);
                        this.hideLoadingPage && this.hideLoadingPage();
                        
                        if (this.record && this.record.error === 'RecordNotFound') {
                            this.notFoundMessage = `Ticket ID ${ticketId} was not found in Zendesk, the cached data could be outdated. Please select another ticket or try again later.`;
                            console.error(`Zendesk - ${this.notFoundMessage}`);
                            this.record = null;
                            return;
                        }
                    }
                },

                addOption(newOption) {
                    // if (!this.selectOptions.includes(newOption)) {
                    //     this.selectOptions.push(newOption);
                    // }
                    // this.selectedIdAndSubject = newOption;
                },

                async handleEnter(event) {
                    const inputValue = event.target.value.trim();
                    if (inputValue) {
                        if (!isNaN(inputValue)) {
                            // retrieveTicket();
                            let ticketId = inputValue;
                            console.log(`Zendesk - you typed ticket id: ${ticketId} and hit Enter`);
                            
                            this.showLoadingPage && this.showLoadingPage();
                            this.selectedIdAndSubject = ticketId;
                            let userSettings = Xrm && Xrm.Utility && Xrm.Utility.getGlobalContext() && Xrm.Utility.getGlobalContext().userSettings;
                            let userName = userSettings && userSettings.userName;
                            let ticket = await this.getTicket(this.zendeskBaseUrl, this.funcCode, ticketId, userName, this.showLoadingPage, this.hideLoadingPage, 
                                this.getZendeskConfigNameByValue, this.getZendeskConfigEmailByKey, this.getZendeskConfigRoleByKey, this.getZendeskConfigNameByKey);

                            // check if the ticket id belong to this reseller
                            let ticketCountry = ticket && ticket.strCountry && ticket.strCountry.toLowerCase().trim();
                            let resellerCountry = Global_originalResellerCountry && Global_originalResellerCountry.toLowerCase().trim();
                            let ticketBCN = ticket && ticket.zendeskBCN && ticket.zendeskBCN;

                            // if (ticketBCN && ticketBCN.indexOf('|') > 0) {
                            //     ticketBCN = ticketBCN.split("|")[1].trim();
                            // }
                            // BCN logic
                            let resellerBCN = Global_originalResellerBCN;
                            let resellerCMPID = Global_originalResellerCMPID;
                            let sameBCN = false;

                            //sameBCN = "ticketBCN == resellerBCN";
                            if (!ticketBCN || ticketBCN.toLowerCase() === 'na' || ticketBCN === '.' || ticketBCN.toLowerCase() === 'x' || !resellerBCN) {
                                sameBCN = false;
                            } else {
                                const validBcn = ticketBCN.replace(/-/g, "");
                                const numbersStrArr = validBcn.match(/\d+/g) || [];
                                numbersStrArr.forEach(bcnItem => {
                                    if (bcnItem.trim() == resellerBCN.trim()) {
                                        sameBCN = true;
                                    }
                                });
                            }

                            let sameCMPID = false;
                            //sameCMPID = "ticketBCN == resellerCMPID";
                            if (!ticketBCN || ticketBCN.toLowerCase() === 'na' || ticketBCN === '.' || ticketBCN.toLowerCase() === 'x' || !resellerBCN) {
                                sameCMPID = false;
                            } else {
                                const validCMPID = ticketBCN.replace(/-/g, "");
                                const numbersStrArr = validCMPID.match(/\d+/g) || [];
                                numbersStrArr.forEach(cmpIdItem => {
                                    if (cmpIdItem.trim() == resellerCMPID.trim() || `'${cmpIdItem.trim()}'` == resellerCMPID.trim()) {
                                        sameCMPID = true;
                                    }
                                });
                            }

                            let sameReseller = ticketCountry == resellerCountry;
                            let belongToReseller = (sameReseller && (sameBCN || sameCMPID));
                            if (belongToReseller && ticketCountry != '-' && ticketBCN != '-') {
                                this.record = ticket;
                                let idAndSubject = `${ticketId}.${ticket.subject}`;
                                if (!this.selectOptions.includes(idAndSubject)) {
                                    this.selectOptions.unshift(idAndSubject);  // add ticketId and subject as the first item of the array
                                }
                                //this.$refs.mySelect.toggle(false);
                                // this.$refs.mySelect.closeDropdown();
                                this.$refs.mySelect.$refs.search.blur();
                                this.hideLoadingPage && this.hideLoadingPage();
                            } else {
                                let msg = "The ticket ID you searched for does not belong to the current reseller. Please search under the correct reseller account or use the Support Tickets dashboard to locate it.";
                                Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: msg });
                                this.hideLoadingPage && this.hideLoadingPage();
                            }
                            
                        } else {
                            this.hideLoadingPage && this.hideLoadingPage();
                            let ticketId = getTicketId(inputValue);
                            if (isNaN(ticketId)) {
                                if (this.selectedIdAndSubject && isNaN(this.selectedIdAndSubject) && isNaN(getTicketId(this.selectedIdAndSubject))) {
                                    Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: "Please type a number as Ticket Id to search." });
                                }
                            }
                        }
                    } else {
                        this.hideLoadingPage && this.hideLoadingPage();
                        Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: "Please type Ticket Id to search." });
                    }
                    this.hideLoadingPage && this.hideLoadingPage();
                },

                async getJsonById(zendeskBaseUrl, jsonPath, jsonId, funcCodeForJsonById) {
                    let result = 'N/A';
                    if (jsonId && jsonId !== 'null') {
                        const response = await axios.get(`${zendeskBaseUrl}/getJsonById?jsonPath=${jsonPath}&jsonId=${jsonId}&code=${funcCodeForJsonById}`);

                        result = response.data ? response.data : '';
                    }
                    return result;
                },

                async getConversation(ticketId, zendeskBaseUrl, funcCodeForComments, MAX_RETRIES, computeBackoff, sleep, hideLoadingPage) {
                    let result = 'N/A';
                    if (ticketId && ticketId !== 'null') {
                        for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                            try {
                                    const response = await axios.get(`${zendeskBaseUrl}/getCommentById?code=${funcCodeForComments}&itemId=${ticketId}`);

                                    // 200 OK
                                    if (response.status === 200) {
                                        result = response.data ? response.data.comments : '';
                                        result && result.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                                        //const resultWithoutLastItem = result.slice(0, -1);
                                        return result;
                                    }

                                    // 429 Rate limited
                                    if (response.status === 429) {
                                        let sleepMs = computeBackoff(attempt);
                                        const retryAfter = response.headers["retry-after"];
                                        if (retryAfter) {
                                            const parsed = parseFloat(retryAfter);
                                            if (!isNaN(parsed)) {
                                                sleepMs = Math.max(sleepMs, parsed * 1000);
                                            }
                                        }
                                        console.error(`[${pageTitle}] 429 rate limited (attempt ${attempt}/${MAX_RETRIES}). Sleeping ${sleepMs}ms.`);
                                        await sleep(sleepMs);
                                        continue;
                                    }

                                    // Server errors -> retry
                                    if (response.status >= 500 && response.status < 600) {
                                        const sleepMs = computeBackoff(attempt);
                                        console.error(`[${pageTitle}] Server error ${response.status} (attempt ${attempt}/${MAX_RETRIES}). Sleeping ${sleepMs}ms.`);
                                        await sleep(sleepMs);
                                        continue;
                                    }

                                    // Other non-recoverable statuses
                                    throw new Error(`Zendesk API error ${response.status}: ${response.statusText}`);

                                } catch (err) {
                                    // If API error and response exists, then the status handled above. Otherwise network error.
                                    let sleepMs = this.computeBackoff(attempt);
                                    console.error(`[${pageTitle}] Network error on attempt ${attempt}/${MAX_RETRIES}: ${err.message || err}. Backing off ${sleepMs}ms`);
                                    await this.sleep(sleepMs);
                                    hideLoadingPage && hideLoadingPage();
                                    this.hideLoadingPage && this.hideLoadingPage();
                                }
                        }
                    }
                },

                async sleep(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                },

                computeBackoff(attempt) {
                    const BACKOFF_BASE_MS =  1000;  // Base wait time for exponential backoff (1 second)
                    const BACKOFF_CAP_MS = 60000;   // Maximum wait time between retries (60 seconds)
                    // attempt is 1-based
                    const exp = BACKOFF_BASE_MS * (2 ** (attempt - 1));
                    const capped = Math.min(exp, BACKOFF_CAP_MS);
                    // jitter between 0.5*capped and capped
                    const low = 0.5 * capped;
                    const jitter = Math.random() * (capped - low) + low;
                    return Math.floor(jitter);
                },

                async getCustomFieldValue(fieldId, fieldValue) {
                    let result = fieldValue;
                    let jsonId = fieldId;
                    let jsonPath = 'ticket_fields/';
                    let fieldData = fieldId ? await this.getJsonById(this.zendeskBaseUrl, jsonPath, jsonId, this.funcCodeForJsonById) : '';
                    if (fieldData && fieldData.ticket_field && fieldData.ticket_field.custom_field_options) {
                        const obj = fieldData.ticket_field.custom_field_options.find(item => item.value === fieldValue);
                        result = obj ? obj.name : fieldValue;
                    }
                    return result;
                },

                async getTicket(zendeskBaseUrl, funcCode, ticketId, userName, showLoadingPage, hideLoadingPage, getZendeskConfigNameByValue, 
                    getZendeskConfigEmailByKey, getZendeskConfigRoleByKey, getZendeskConfigNameByKey) {
                    showLoadingPage && showLoadingPage();
                    this.showLoadingPage && this.showLoadingPage();
                    const fullUrl = `${zendeskBaseUrl}/getDataById?code=${funcCode}&category=tickets&itemId=${ticketId}&userName=${userName}`;
                    console.log(fullUrl);
                    let pageTitle = this.pageTitle || 'Zendesk Ticket Viewer';
                    // API Request & Retry Configuration: Maximum number of retry attempts for failed API calls
                    const MAX_RETRIES = 6;

                    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                        if (ticketId && ticketId !== 'null') {
                            try {
                                const response = await axios.get(fullUrl);

                                // 200 OK
                                if (response.status === 200) {
                                    let result = response.data;
                                    if (result) {
                                        if (result && result.ticket) {
                                            result = {
                                            ...result,
                                            ...result.ticket
                                            };
                                            delete result.ticket;
                                        
                                            let jsonPath = 'users';
                                            let jsonId = result.requester_id;
                                            result.requesterEmail = await getZendeskConfigEmailByKey(jsonId);
                                            if (!result.requesterEmail) {
                                                let userData = jsonId ? await this.getJsonById(zendeskBaseUrl, jsonPath, jsonId, this.funcCodeForJsonById) : '';
                                                result.requesterEmail = userData.user ? userData.user.email : '';
                                            }

                                            let jsonIdForAssignee = result.assignee_id;
                                            result.strAgent = await getZendeskConfigNameByKey(jsonIdForAssignee);
                                            if (!result.strAgent) {
                                                let agentData = jsonIdForAssignee ? await this.getJsonById(zendeskBaseUrl, jsonPath, jsonIdForAssignee, this.funcCodeForJsonById) : '';
                                                result.strAgent = agentData.user ? agentData.user.name : '-';
                                            }
                                            result.conversations = await this.getConversation(ticketId, zendeskBaseUrl, this.funcCodeForComments, MAX_RETRIES, this.computeBackoff, this.sleep, hideLoadingPage);
                                            if (result.conversations) {
                                                for (let item of result.conversations) {
                                                    jsonId = item.author_id;
                                                    result.author_email = await getZendeskConfigEmailByKey(jsonId);
                                                    item.role = await getZendeskConfigRoleByKey(jsonId);
                                                    if (!result.author_email || !item.role) {
                                                        let userData = jsonId ? await this.getJsonById(zendeskBaseUrl, jsonPath, jsonId, this.funcCodeForJsonById) : '';
                                                        result.author_email = userData.user ? userData.user.email : '';
                                                        item.role = userData.user ? userData.user.role : '';
                                                    }
                                                    item.author_email = result.author_email;

                                                    if (item.public == false) {
                                                        item.dynamicColor = "#fff3e4";
                                                    } else {
                                                        if (item.role == "agent") {
                                                            item.dynamicColor = "#f8f9f9";
                                                        }
                                                        if (item.role == "end-user") {
                                                            item.dynamicColor = "#ecf9f9";
                                                        }
                                                    }
                                                }
                                            }
                                            
                                            let domainFieldId = isStage ? 31042462931476 : 34698829065236;
                                            const objDomain = result.custom_fields && result.custom_fields.find(item => item.id === domainFieldId);
                                            const domainValue = objDomain ? objDomain.value : '';
                                            result.strDomain = await getZendeskConfigNameByValue(domainValue);
                                            if (!result.strDomain) {
                                                result.strDomain = domainValue? await this.getCustomFieldValue(domainFieldId, domainValue) : '';
                                            }
                                            let supportTierFieldId = isStage ? 33937714050708 : 34698770438676;
                                            const objTier = result.custom_fields && result.custom_fields.find(item => item.id === supportTierFieldId);
                                            const tierValue = objTier ? objTier.value : '';
                                            result.strSupportTier = await getZendeskConfigNameByValue(tierValue);
                                            if (!result.strSupportTier) {
                                                result.strSupportTier = tierValue ? await this.getCustomFieldValue(supportTierFieldId, tierValue) : '';
                                            }
                                            let platformFieldId = isStage ? 35415435690388 : 35228789545364;
                                            const objPlatform = result.custom_fields && result.custom_fields.find(item => item.id === platformFieldId);
                                            const platformValue = objPlatform ? objPlatform.value : '';
                                            result.strPlatform = await getZendeskConfigNameByValue(platformValue);
                                            if (!result.strPlatform) {
                                                result.strPlatform = platformValue ? await this.getCustomFieldValue(platformFieldId, platformValue) : '';
                                            }
                                            let vendorFieldId = isStage ? 36211322445460 : 35229050467860;
                                            const objVendor = result.custom_fields && result.custom_fields.find(item => item.id === vendorFieldId);
                                            const vendorValue = objVendor ? objVendor.value : '';
                                            result.strVendor = await getZendeskConfigNameByValue(vendorValue);
                                            if (!result.strVendor) {
                                                result.strVendor = vendorValue ? await this.getCustomFieldValue(vendorFieldId, vendorValue) : '';
                                            }
                                            let countryFieldId = isStage ? 31959436739604 : 35138178531732;
                                            const objCountry = result.custom_fields && result.custom_fields.find(item => item.id === countryFieldId);
                                            const countryValue = objCountry ? objCountry.value : '';
                                            result.strCountry = await getZendeskConfigNameByValue(countryValue);
                                            if (!result.strCountry) {
                                                result.strCountry = countryValue ? await this.getCustomFieldValue(countryFieldId, countryValue) : '';
                                            }

                                            let bcnFieldId = isStage ? 21077919616660 : 9213900294676;
                                            const objBCN = result.custom_fields && result.custom_fields.find(item => item.id === bcnFieldId);
                                            const bcnValue = objBCN ? objBCN.value : '';
                                            // result.zendeskBCN = await getZendeskConfigNameByValue(accessToken, log, bcnValue);
                                            // if (!result.zendeskBCN && bcnValue != 'NA' && bcnValue != 'N/A') {
                                            //     result.zendeskBCN = bcnValue ? await getCustomFieldValue(log, bcnFieldId.toString(), bcnValue) : '';
                                            // }
                                            result.zendeskBCN = bcnValue ? bcnValue : '-';
                                            Global_ZendeskBCN = result.zendeskBCN;

                                            hideLoadingPage && hideLoadingPage();
                                            this.hideLoadingPage && this.hideLoadingPage();
                                        }
                                    }
                                    
                                    return result;
                                }

                                // 429 Rate limited
                                if (response.status === 429) {
                                    let sleepMs = this.computeBackoff(attempt);
                                    const retryAfter = response.headers["retry-after"];
                                    if (retryAfter) {
                                        const parsed = parseFloat(retryAfter);
                                        if (!isNaN(parsed)) {
                                            sleepMs = Math.max(sleepMs, parsed * 1000);
                                        }
                                    }
                                    console.error(`[${pageTitle}] 429 rate limited (attempt ${attempt}/${MAX_RETRIES}). Sleeping ${sleepMs}ms.`);
                                    await this.sleep(sleepMs);
                                    continue;
                                }

                                // Server errors -> retry
                                if (response.status >= 500 && response.status < 600) {
                                    const sleepMs = this.computeBackoff(attempt);
                                    console.error(`[${pageTitle}] Server error ${response.status} (attempt ${attempt}/${MAX_RETRIES}). Sleeping ${sleepMs}ms.`);
                                    await this.sleep(sleepMs);
                                    continue;
                                }

                                // Other non-recoverable statuses
                                throw new Error(`Zendesk API error ${response.status}: ${response.statusText}`);

                            } catch (err) {
                                // If API error and response exists, then the status handled above. Otherwise network error.
                                let sleepMs = this.computeBackoff(attempt);
                                console.error(`[${pageTitle}] Network error on attempt ${attempt}/${MAX_RETRIES}: ${err.message || err}. Backing off ${sleepMs}ms`);
                                await this.sleep(sleepMs);
                                hideLoadingPage && hideLoadingPage();
                                this.hideLoadingPage && this.hideLoadingPage();
                            }


                        } else {
                            hideLoadingPage && hideLoadingPage();
                            this.hideLoadingPage && this.hideLoadingPage();
                            return null;
                        }
                    }
                },

                showLoadingPage() {
                    this.showLoading = true;
                },

                hideLoadingPage() {
                    if (Date.now() - this.startTime < 500) {
                        setTimeout(() => {
                            this.showLoading = false;
                        }, 500);
                    } else {
                        this.showLoading = false;
                    }
                },

                getTicketSummary(items) {
                    const result = [];
                    try {
                        items.forEach(item => {
                            const createdAt = new Date(item.im360_created_at);
                            const strMonth = (createdAt.getMonth() + 1).toString();
                            const fullMonth = strMonth.length === 1 ? `0${strMonth}` : `${strMonth}`;
                            const yearAndMonth = `${createdAt.getFullYear()}-${fullMonth}`;
                            const ticketObj = {
                                yearAndMonth,
                            }
                            result.push(ticketObj);
                        });
                    } catch (err) {
                        console.error(`${this.pageTitle} - Zendesk getTicketSummary error`);
                        this.hideLoadingPage && this.hideLoadingPage();
                    }
                    return result;
                },

                getGroupByMonthTickets(ticketSummaryParam) {
                    let result = '';
                    try {
                        const groupByMonth = groupBy("yearAndMonth");
                        const groupedTickets = groupByMonth(ticketSummaryParam);
                        Object.keys(groupedTickets).forEach(key => {
                            if (result && result.length > 0) {
                                result += '<br>';
                            }
                            result += key;
                            result += ': ';
                            result += `<b>${groupedTickets[key]}</b>`;
                        });
                    } catch (err) {
                        console.error(`${this.pageTitle} - getGroupByMonthTickets error`);
                        this.hideLoadingPage && this.hideLoadingPage();
                    }
                    return result;
                },
                async retrieveTicket() {
                    let ticketId = this.inputTicketId;
                    if (!ticketId) {
                        Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: "Please type Ticket Id to search" });
                    } else {
                        this.showLoadingPage && this.showLoadingPage();
                        this.selectedIdAndSubject = '';
                        this.record = await this.getTicket(this.zendeskBaseUrl, this.funcCode, ticketId, '', this.showLoadingPage, this.hideLoadingPage, 
                            this.getZendeskConfigNameByValue, this.getZendeskConfigEmailByKey, this.getZendeskConfigRoleByKey, this.getZendeskConfigNameByKey);
                        this.hideLoadingPage && this.hideLoadingPage();
                    }
                }
            }
        });

        const getTicketId = (selectedIdAndSubject) => {
            const ticketId = (selectedIdAndSubject && selectedIdAndSubject.indexOf('.') > 0) ? selectedIdAndSubject.substring(0, selectedIdAndSubject.indexOf('.')) : selectedIdAndSubject;
            return ticketId;
        };

        const groupBy = (key) => {
            return function group(array) {
                return array.reduce((acc, obj) => {
                    const property = obj[key];
                    acc[property] = acc[property] ? acc[property] + 1 : 1;
                    return acc;
                }, {});
            };
        };

        const extractBCNTokens = (value) => {
            if (!value) return [];

            // Extract tokens: letters+digits with optional hyphens, ≥4 characters
            return value
                .match(/[A-Za-z0-9][A-Za-z0-9-]{3,}/g)          // find tokens
                ?.map(x => x.replace(/-/g, "").toUpperCase())   // normalize
                || [];
        };

        const filterExactBCNResults = (records, bcnRaw) => {
            if (!bcnRaw || bcnRaw.trim() === "") {
                return records;
            }
            const validTokens = extractBCNTokens(bcnRaw);

            return records.filter(rec => {
                const fieldValue = rec["im360_ingrambcn"];
                const tokens = extractBCNTokens(fieldValue);
                return tokens.some(t => validTokens.includes(t));
            });
        };
    </script>

    <style scoped>
        body {
            height: 100%;
            -moz-osx-font-smoothing: grayscale;
            -webkit-font-smoothing: antialiased;
            font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica Neue, Helvetica, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial, sans-serif;
        }

        #viewerHead {
            text-align: left;
            margin-top: 10px;
            margin-left: 20px;
            float: left;
            width: 100%;
            font-size: 14px;
        }

        #viewerHeadOtherInfo {
            text-align: left;
            margin-top: 10px;
            margin-left: 20px;
            float: left;
            width: 100%;
            font-size: 14px;
        }

        .details td {
            width: 100px;
        }

        .MainMessage {
            overflow: auto;
            text-align: left;
            background-color: #93dde3;
            padding: 1%;
            font-size: 14px;
            border-radius: 25px;
            border: solid 1.5px black;
            margin-left: 20px;
            margin-right: 20px;
            margin-top: 50px;
        }

        .MainMessageConversation {
            overflow: auto;
            text-align: left;
            padding: 1%;
            font-size: 14px;
            border-radius: 25px;
            border: solid 1.5px black;
            margin-left: 20px;
            margin-right: 20px;
            margin-top: 20px;
        }

        .MessageHeader {
            text-align: left;
            margin-left: 20px;
            font-style: italic;
        }

        .MessageHeaderWithoutLeftMargin {
            text-align: left;
            font-style: italic;
        }

        .conversations {
            word-wrap: break-word;
            text-align: left;
            background-color: #c8edf2;
            padding: 1%;
            font-size: 14px;
            border-radius: 25px;
            border: solid 1.5px black;
            margin: 10px 20px 10px 100px;
        }

        #tags {
            margin: 0;
            padding: 0;
        }

        #tags li {
            display: inline;
            text-decoration: none;
            padding: 0.2em 1em;
        }

        .inline {
            display: inline-block;
            margin-right: 20px;
        }

        ul {
            list-style-type: none;
            overflow: hidden;
        }

        table,
        th,
        td {
            border: 1px solid #dddddd;
            border-collapse: collapse;
            text-align: center;
            padding: 7px;
        }

        .underlined {
            text-decoration: underline;
            padding-left: 15px;
            cursor: pointer;
            color: #408cf0;
        }

        #tags {
            margin: 0 0 -5px 2px;
            display: inline-block;
        }

        .conversation {
            margin-left: -40px;
            margin-bottom: 60px;
        }

        .recordTags {
            margin: -10px 0 20px 0;
        }

        .recordTagsShort {
            margin-left: 40px;
        }

        .boldTags {
            width: 40px;
            display: inline-block;
            margin-right: 0px;
        }

        .boldDue {
            width: 90px;
            display: inline-block;
            margin-right: 0px;
        }

        .boldRequester {
            width: 150px;
            display: inline-block;
            margin-right: 0px;
        }

        .boldInMinutes {
            width: 210px;
            display: inline-block;
            margin-left: 20px;
        }

        .boldCompany {
            width: 50px;
        }

        .scrollableDiv {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            overflow-wrap: break-word;
        }

        /* loading image */
        #loading {
            width: 100%;
            height: 100%;
            top: 0px;
            left: 0px;
            position: fixed;
            display: block;
            opacity: 0.85;
            background-color: #fff;
            z-index: 99;
            text-align: center;
        }

        #loading-content {
            position: absolute;
            top: 30%;
            left: 45%;
            text-align: center;
            z-index: 100;
        }

        .select-box {
            margin-right: 220px;
        }

        .expand-button {
            float: right;
            margin-top: -30px;
            margin-right: 20px;
        }

        .expand-image {
            cursor: pointer;
            margin-left: 10px;
            margin-bottom: -3px;
        }

        .not-found {
            margin-top: 20px;
        }

        .collapse-ticket-summary {
            margin-left: 20px;
            margin-right: 20px;
        }

        .el-collapse-item {
            position: relative;
        }

        .more-btn {
            float: right;
            background-color: transparent;
            border: none;
            margin-right: .5rem;
            i {
                margin-left: 1rem;
            }

        }

        .el-collapse-item__arrow {
            float: left;
            margin: 0 0.5rem;
            width: 1rem;
            text-align: center;
        }

        .min-col-bcn {
            min-width: 153px;
        }
    </style>

</body>

</html>