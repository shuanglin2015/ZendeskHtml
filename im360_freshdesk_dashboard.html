<!DOCTYPE html>
<html>

<head>
    <script src="ClientGlobalContext.js.aspx"></script>
    <script src="im360_common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/jquery@3.1.1/dist/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.2.0/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui@2.2.0/lib/index.js"></script>

    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/20.2.7/css/dx.common.css">
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/20.2.7/css/dx.light.css">
    <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/20.2.7/js/dx.web.js"></script>
</head>

    <body>
        <div id="app" class='datagrid'>
            <div v-if="showLoading" id="loading">
                <div id="loading-content">
                    <img src="im360_Loading.gif" />
                </div>
            </div>
            <div title="Click a row to view the ticket's detail tab.">
              <div id="gridContainer"></div>
            </div>
        </div>

        <script>
            let isStage = true;
            let zendeskBaseUrl = '';
            let funcCodeForJsonById = '';
            let finalFilterArr = ["<condition attribute='im360_created_at' operator='gt' value='1989-01-01 ' />"];
            let zendeskCountryName = '';
            let zendeskBCN = '';

            let app = new Vue({
                el: '#app',
                data: {
                    pageTitle: 'ZendeskDashboard',
                    showLoading: true,
                    freshdeskUrl: '',
                    // default appId value when Configuration FreshdeskAPI -> Value3 is not configured
                    appId: '80ffd75d-69ec-ea11-a817-000d3a8bdb91',
                    // default formId value when Configuration FreshdeskAPI -> Value4 is not configured
                    formId: 'c822d616-dce1-4671-a5ac-a9c3cadb5c2d',
                },
                async mounted() {
                    this.showLoadingPage();

                    let freshdeskConfig = await this.getFreshdeskConfig();
                    if (freshdeskConfig) {
                        let baseUrl = freshdeskConfig.im360_value;
                        this.zendeskBaseUrl = baseUrl;
                        console.log(`${this.pageTitle} - zendeskBaseUrl from FreshdeskAPI configuration: ${this.zendeskBaseUrl}`);
                        let funcCode = freshdeskConfig.im360_value2;
                        let funcCodeArr = funcCode.toString().split(';;;;');
                        let firstFuncCode = funcCodeArr[2];
                        this.freshdeskUrl = `${baseUrl}/searchByResellerId?code=${firstFuncCode}&resellerId=`;
                        this.funcCodeForJsonById = funcCodeArr[3];

                        let im360_value3 = freshdeskConfig.im360_value3;
                        if (im360_value3) {
                            this.appId = im360_value3;
                            console.log(`${this.pageTitle} - appId from FreshdeskAPI configuration: ${this.appId}`);
                        }

                        let im360_value4 = freshdeskConfig.im360_value4;
                        if (im360_value4) {
                            this.formId = im360_value4;
                            console.log(`${this.pageTitle} - formId from FreshdeskAPI configuration: ${this.formId}`);
                        }
                    } else {
                        console.error(`${this.pageTitle} - freshdeskConfig is null`);
                    }

                    if (this.freshdeskUrl) {
                        console.log(`${this.pageTitle} - freshdeskUrl: ${this.freshdeskUrl}`);

                        let stageApi = 'crm-zendesk-api.azurewebsites.net';
                        if (this.freshdeskUrl && this.freshdeskUrl.indexOf(stageApi) > -1) {
                            isStage = true;
                        } else {
                            isStage = false;
                        }
                        zendeskCountryName = localStorage.getItem('zendesk_country_name');
                        zendeskBCN = localStorage.getItem('zendesk_bcn');
                        // let loadOptions = {
                        //     skip: 0,             // how many records to skip (for paging)
                        //     take: 100,           // how many records to load (page size)
                        //     sort: [
                        //         { selector: "im360_ticketid", desc: true }
                        //     ],
                        //     filter: [
                        //         ["im360_created_at", "gt", "1980-01-01"]
                        //     ],
                        //     searchExpr: ['im360_ticketid', 'im360_country', 'im360_ingrambcn', 'im360_partneremailaddress', 'im360_resellername', 'im360_name', 'im360_status', 'im360_domain', 'im360_priority'], // which fields to search
                        //     searchOperation: "contains",
                        //     searchValue: "john",           // search panel text
                        //     requireTotalCount: false,       // if grid needs total record count
                        // };
                        //let tickets = await this.getTickets(loadOptions);
                        //console.log(`${this.pageTitle} - tickets: ${JSON.stringify(tickets)}`);
                        localStorage.setItem('zendesk_country_name', '');
                        localStorage.setItem('zendesk_bcn', '')
                        this.generateDatagrid(this.getTickets); 
                    } else {
                        console.error(`${this.pageTitle} - Zendesk API URL is null`);
                    }

                },
                methods: {
                    async getFreshdeskConfig() {
                        let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                         <entity name='im360_configuration'> \
                             <attribute name='im360_value'/> \
                             <attribute name='im360_value2'/> \
                             <attribute name='im360_value3'/> \
                             <attribute name='im360_value4'/> \
                             <filter type='and'> \
                                 <condition attribute='im360_name' operator='eq' value='FreshdeskAPI' /> \
                                 <condition attribute='statuscode' operator='eq' value='1' /> \
                             </filter> \
                         </entity> \
                         </fetch>";

                        let pageTitle = this.pageTitle;
                        return Xrm.WebApi.retrieveMultipleRecords("im360_configuration", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null) {
                                    return result.entities[0];
                                } else {
                                    console.error(`${pageTitle} - Cannot get Zendesk configuration.`);
                                    return null;
                                }
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                this.hideLoadingPage();
                                return null;
                            }
                        );
                    },

                    async getAccountIdByCountryAndBCN(country, bcn) {
                        if (country && bcn) {
                            let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                                <entity name='account'> \
                                    <attribute name='accountid' /> \
                                    <link-entity name='im360_country' from='im360_countryid' to='im360_country' link-type='inner'> \
                                        <attribute name='im360_name' alias='CountryName' /> \
                                        <filter type='and'> \
                                            <condition attribute='im360_name' operator='eq' value='" + country + "' /> \
                                        </filter> \
                                    </link-entity> \
                                    <filter type='and'> \
                                        <condition attribute='im360_bcn' operator='eq' value='" + bcn + "' /> \
                                    </filter> \
                                </entity> \
                                </fetch>";

                            let pageTitle = this.pageTitle;
                            return Xrm.WebApi.retrieveMultipleRecords("account", "?fetchXml=" + fetchXml).then(
                                function success(result) {
                                    if (result != null) {
                                        return result.entities[0];
                                    } else {
                                        console.error(`${pageTitle} - Cannot get Account by Country and BCN.`);
                                        return null;
                                    }
                                },
                                function (error) {
                                    console.error(`${pageTitle} - ${error.message}`);
                                    this.hideLoadingPage && this.hideLoadingPage();
                                    return null;
                                }
                            );
                        } else{
                            return null;
                        }
                    },

                    // async getTickets (loadOptions) {
                    //     console.log("loadOptions:", loadOptions);
                    //     const entityName = "im360_zendesktickets";
                    //     const pageSize = loadOptions.take || 100;
                    //     const currentSkip = loadOptions.skip || 0;
                    //     const requestedPage = Math.floor(currentSkip / pageSize) + 1;

                    //     // Reset cookie if we start over (new filter/search/sort)
                    //     if (requestedPage < lastPage) {
                    //         pagingCookie = null;
                    //         lastPage = 1;
                    //     }

                    //     // --- FILTERING (filterRow) ---
                    //     let filterXml = "";
                    //     if (loadOptions.filter) {
                    //         filterXml += buildFetchFilterXml(loadOptions.filter);
                    //     }

                    //     // --- SEARCH PANEL (search across fields) ---
                    //     if (loadOptions.searchValue && loadOptions.searchExpr) {
                    //         const searchValue = loadOptions.searchValue;
                    //         const fields = Array.isArray(loadOptions.searchExpr)
                    //         ? loadOptions.searchExpr
                    //         : [loadOptions.searchExpr];

                    //         // Build an OR filter for all search fields
                    //         filterXml += `<filter type="or">
                    //         ${fields
                    //             .map(
                    //             f =>
                    //                 `<condition attribute="${f}" operator="like" value="%${searchValue}%" />`
                    //             )
                    //             .join("")}
                    //         </filter>`;
                    //     }

                    //     // --- SORTING ---
                    //     let orderXml = "";
                    //     if (loadOptions.sort && loadOptions.sort.length > 0) {
                    //         const sort = loadOptions.sort[0];
                    //         orderXml = `<order attribute="${sort.selector}" descending="${sort.desc}" />`;
                    //     } else {
                    //         orderXml = `<order attribute="createdon" descending="true" />`; // default
                    //     }

                    //     // --- FINAL FetchXML ---
                    //     const fetchXml = `
                    //         <fetch count='${pageSize}' page='${requestedPage}'>
                    //         ${pagingCookie ? pagingCookie : ""}
                    //         <entity name='${entityName}'>
                    //             <attribute name='new_customentityid' />
                    //             <attribute name='new_name' />
                    //             <attribute name='statuscode' />
                    //             <attribute name='prioritycode' />
                    //             <attribute name='createdon' />
                    //             <filter type='and'>
                    //             ${filterXml}
                    //             </filter>
                    //             ${orderXml}
                    //         </entity>
                    //         </fetch>
                    //     `;

                    //     const encodedFetchXml = "?fetchXml=" + encodeURIComponent(fetchXml);

                    //     try {
                    //         const result = await Xrm.WebApi.retrieveMultipleRecords(entityName, encodedFetchXml);

                    //         // Save paging-cookie for next batch
                    //         if (result["@Microsoft.Dynamics.CRM.fetchxmlpagingcookie"]) {
                    //         pagingCookie = result["@Microsoft.Dynamics.CRM.fetchxmlpagingcookie"];
                    //         lastPage = requestedPage;
                    //         } else {
                    //         pagingCookie = null; // reached end
                    //         }

                    //         // Map data
                    //         const items = result.entities.map(e => ({
                    //         id: e["new_customentityid"],
                    //         name: e["new_name"],
                    //         status: e["statuscode@OData.Community.Display.V1.FormattedValue"],
                    //         priority: e["prioritycode@OData.Community.Display.V1.FormattedValue"],
                    //         createdon: e["createdon"]
                    //         }));

                    //         return {
                    //         data: items,
                    //         totalCount: requestedPage * pageSize + items.length,
                    //         };
                    //     } catch (err) {
                    //         console.error("FetchXML load error:", err);
                    //         throw err;
                    //     }
                    // },
                    
                    async getTickets() {
                        let results = [];
                        //let filter = "<condition attribute='im360_created_at' operator='gt' value='2001-01-01 ' />";

                        let countryFilter = `<condition attribute='im360_country' operator='eq' value='${zendeskCountryName}' />`;
                        let partOfCountryFilter = "<condition attribute='im360_country'";
                        finalFilterArr = finalFilterArr.filter(item => !item.includes(partOfCountryFilter));
                        if (zendeskCountryName) {
                            finalFilterArr.push(countryFilter);
                        }

                        let bcnFilter = `<condition attribute='im360_ingrambcn' operator='eq' value='${zendeskBCN}' />`;
                        let partOfBcnFilter = "<condition attribute='im360_ingrambcn'";
                        finalFilterArr = finalFilterArr.filter(item => !item.includes(partOfBcnFilter));
                        if (zendeskBCN) {
                            finalFilterArr.push(bcnFilter);
                        }

                        let fetchXml = `<fetch top='5000'> \
                                            <entity name='im360_zendesktickets'> \
                                                <attribute name='im360_ticketid' /> \
                                                <attribute name='im360_name' /> \
                                                <attribute name='im360_country' /> \
                                                <attribute name='im360_created_at' /> \
                                                <attribute name='im360_domain' /> \
                                                <attribute name='im360_ingrambcn' /> \
                                                <attribute name='im360_partneremailaddress' /> \
                                                <attribute name='im360_priority' /> \
                                                <attribute name='im360_resellername' /> \
                                                <attribute name='im360_resolved_at' /> \
                                                <attribute name='im360_resolvehours' /> \
                                                <attribute name='im360_status' /> \
                                                <attribute name='im360_updated_at' /> \
                                                <link-entity name='im360_country' from='im360_name' to='im360_country' alias='country'> \
                                                <attribute name='im360_name' /> \
                                                <filter type='and'> \
                                                    <condition attribute='statecode' operator='eq' value='0' /> \
                                                </filter> \
                                                </link-entity> \
                                                <filter type='and'> ${finalFilterArr.toString()} </filter> \
                                                <order descending='true' attribute='im360_created_at' /> \
                                            </entity> \
                                        </fetch>`;

                        let pageTitle = this.pageTitle;
                        return Xrm.WebApi.retrieveMultipleRecords("im360_zendesktickets", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null) {
                                    let items = result.entities;
                                    if (items && items.length > 0) {
                                        items.forEach(item => {
                                            if (item && item.im360_name) {
                                                let itemNew = {
                                                    'TicketId': item.im360_ticketid,
                                                    'Country': item.im360_country ? item.im360_country : '-',
                                                    'Ingram BCN#': item.im360_ingrambcn ? item.im360_ingrambcn : '-',
                                                    'Partner email address': item.im360_partneremailaddress ? item.im360_partneremailaddress : '-',
                                                    'Reseller Name': item.im360_resellername ? item.im360_resellername : '-',
                                                    'Ticket subject line': item.im360_name ? item.im360_name : '-',
                                                    'Status': item.im360_status ? item.im360_status : '-',
                                                    'Domain': item.im360_domain ? item.im360_domain : '-',
                                                    'Priority': item.im360_priority ? item.im360_priority : '-'
                                                };

                                                console.log(`${pageTitle} - item after adding more fields: ${JSON.stringify(itemNew)}`);
                                                results.push(itemNew);
                                            }
                                        });
                                    }
                                    return results;
                                } else {
                                    console.error(`${pageTitle} - Cannot get Zendesk tickets.`);
                                    return null;
                                }
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                this.hideLoadingPage();
                                return null;
                            }
                        );
                    },

                    generateDatagrid(getTickets) {
                        let pageTitle = this.pageTitle;
                        let appId = this.appId;
                        let formId = this.formId;
                        let getAccountIdByCountryAndBCN = this.getAccountIdByCountryAndBCN;

                        // dataSource: ticketsArr,
                        $("#gridContainer").dxDataGrid({
                            dataSource: new DevExpress.data.CustomStore({
                                key: "TicketId",
                                load: getTickets
                            }),
                            remoteOperations: false,
                            allowColumnReordering: true,
                            rowAlternationEnabled: true,
                            allowColumnResizing: true,
                            columnAutoWidth: true,
                            columnChooser: { enabled: true },
                            columnFixing: { enabled: true },
                            filterRow: { visible: true },
                            headerFilter: { visible: true },
                            editing: { mode: `form`, allowUpdating: false, allowEditing: false, allowAdding: false, allowDeleting: false },
                            export: { enabled: true, fileName: `item` },
                            grouping: { contextMenuEnabled: true },
                            groupPanel: { visible: true },
                            hoverStateEnabled: true,
                            loadPanel: { height: 100, width: 200, text: `Loading Data...` },
                            pager: { showInfo: true, infoText: `Page {0}. Total: {1} ({2} items)`, showPageSizeSelector: true, allowedPageSizes: [5, 15, 30] },
                            paging: { pageSize: 15, pageIndex: 0 },
                            searchPanel: { visible: true, width: 240, placeholder: `Search...` },
                            selection: { mode: `single` },
                            sorting: { mode: `multiple` },
                            showBorders: true,
                            showColumnLines: true,
                            showRowLines: true,
                            showScrollbar: true,
                            useNative: false,
                            onInitialized(e) {
                                window.gridInstance = e.component; // store grid reference globally if needed
                            },
                            onOptionChanged(e) {
                                if (e.name != "hoveredElement") {
                                    if (e.name === "columns") {
                                        clearTimeout(window.searchTimer);
                                        window.searchTimer = setTimeout(() => {
                                            e.component.refresh(); // reload data
                                        }, 800); // wait 800ms after user stops typing
                                    }

                                    // // global search:
                                    // if (e.name === "searchPanel" && e.fullName === "searchPanel.text") {
                                    //     console.log("User global search value changed:", e.value);
                                    // }
                                    
                                    // (1) search Ticket id:
                                    if (e.name === "columns" && e.fullName === "columns[0].filterValue") {
                                        let filter = `<condition attribute='im360_ticketid' operator='eq' value='${e.value}' />`;
                                        let partOfFilter = "<condition attribute='im360_ticketid'";
                                        finalFilterArr = finalFilterArr.filter(item => !item.includes(partOfFilter));
                                        if (e.value) {
                                            finalFilterArr.push(filter);
                                        }
                                        // trigger the data retrieve
                                        console.log("User column search value changed for Ticket id:", e.value);
                                    }

                                    // (2) search Country:
                                    if (e.name === "columns" && e.fullName === "columns[1].filterValue") {
                                        console.log("User column search value changed for Country:", e.value);
                                    }

                                    // (3) search Ingram BCN#:
                                    if (e.name === "columns" && e.fullName === "columns[2].filterValue") {
                                        console.log("User column search value changed for Ingram BCN#:", e.value);
                                    }

                                    // (4) search Partner email address:
                                    if (e.name === "columns" && e.fullName === "columns[3].filterValue") {
                                        console.log("User column search value changed for Partner email address:", e.value);
                                    }

                                    // (5) search Reseller Name:
                                    if (e.name === "columns" && e.fullName === "columns[4].filterValue") {
                                        console.log("User column search value changed for Reseller Name:", e.value);
                                    }

                                    // (6) search Ticket subject line:
                                    if (e.name === "columns" && e.fullName === "columns[5].filterValue") {
                                        console.log("User column search value changed for Ticket subject line:", e.value);
                                    }

                                    // (7) search Status:
                                    if (e.name === "columns" && e.fullName === "columns[6].filterValue") {
                                        console.log("User column search value changed for Status:", e.value);
                                    }

                                    // (8) search Domain:
                                    if (e.name === "columns" && e.fullName === "columns[7].filterValue") {
                                        console.log("User column search value changed for Domain:", e.value);
                                    }

                                    // (9) search Priority:
                                    if (e.name === "columns" && e.fullName === "columns[8].filterValue") {
                                        console.log("User column search value changed for Priority:", e.value);
                                    }
                                }
                            },
                            onRowClick: async function (e) {
                                let data = e.data; // selectedItems.selectedRowsData[0];
                                console.log(`${pageTitle} - onRowClick -> data: ${JSON.stringify(data)}`);
                                
                                let country = data['Country'];
                                let bcn = data['Ingram BCN#'];
                                // if (country && accountId != '-') {
                                if (country && country != '-' && bcn && bcn != '-') {
                                    let accountData = await getAccountIdByCountryAndBCN(country, bcn);
                                    /*let accountId = '8e70a94a-9a02-e911-a961-000d3a30e34c';*/
                                    let accountId = accountData ? accountData.accountid : '-';
                                    console.log(`${pageTitle} - onRowClick -> accountId: ${accountId}`);

                                    let ticketId = data.TicketId;
                                    let url = window.location.protocol + "//" + window.location.host + "/";
                                    let fieldName = 'im360_newnavigationtab';
                                    let tabName = 'tab_freshdesk';    
                                    let selectedResellerId = data['Ingram BCN#'];

                                    if (accountId && accountId != '-') {
                                        let fullUrl = `${url}/main.aspx?appid=${appId}&forceUCI=1&pagetype=entityrecord&etn=account&id=${accountId}&formid=${formId}&extraqs=${fieldName}%3D${tabName}_${ticketId}_${selectedResellerId}`;
                                        console.log(`${pageTitle} - fullUrl: ${fullUrl}`);
                                        localStorage.setItem('zendesk_ticketId', ticketId);
                                        window.open(fullUrl, '_blank');
                                    } else {
                                        Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: "Cannot get Account Id by Country and BCN. Unable to load account details." })
                                    }
                                } else {
                                    Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: "Country or BCN is not available. Unable to load account details." })
                                }
                                return null;
                            }
                        });
                        this.hideLoadingPage();
                    },

                    showLoadingPage() {
                        //this.showLoading = true;
                    },

                    hideLoadingPage() {
                        try {
                            setTimeout(() => {
                                this.showLoading = false;
                            }, 1000);
                        } catch (ex) {
                            this.showLoading = false;
                        }
                    }
                }
                
            });
        </script>


        <style scoped>
            body {
                height: 100%;
                -moz-osx-font-smoothing: grayscale;
                -webkit-font-smoothing: antialiased;
                font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica Neue, Helvetica, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial, sans-serif;
            }

            /* loading image */
            #loading {
                width: 100%;
                height: 100%;
                top: 0px;
                left: 0px;
                position: fixed;
                display: block;
                opacity: 0.85;
                background-color: #fff;
                z-index: 99;
                text-align: center;
            }

            #loading-content {
                position: absolute;
                top: 30%;
                left: 45%;
                text-align: center;
                z-index: 100;
            }

            .datagrid {
                margin: 10px 20px 10px 20px;
            }

            .dx-checkbox-container {
                height: 25px;
            }
        </style>

    </body>

</html>
