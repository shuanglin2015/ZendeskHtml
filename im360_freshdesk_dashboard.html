<!DOCTYPE html>
<html>

<head>
    <script src="ClientGlobalContext.js.aspx"></script>
    <script src="im360_common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/jquery@3.1.1/dist/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.2.0/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui@2.2.0/lib/index.js"></script>

    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/20.2.7/css/dx.common.css">
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/20.2.7/css/dx.light.css">
    <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/20.2.7/js/dx.web.js"></script>
</head>

    <body>
        <div id="app" class='datagrid'>
            <div title="Click a row to view the ticket's detail tab.">
              <div id="gridContainer"></div>
            </div>
        </div>

        <script>
            let isStage = true;
            let Global_zendeskBaseUrl = '';
            let Global_freshdeskUrl = '';
            let Global_funcCodeForJsonById = '';
            let Global_finalFilterArr = ["<condition attribute='im360_created_at' operator='gt' value='1989-01-01 ' />"];
            let Global_ticketSearchFromZendeskAPI = '';

            let Global_country_name = '';
            let Global_im360_bcn = '';
            let Global_im360_armid = '';

            let app = new Vue({
                el: '#app',
                data: {
                    Global_freshdeskUrl: '',
                    // default appId value when Configuration FreshdeskAPI -> Value3 is not configured
                    appId: '80ffd75d-69ec-ea11-a817-000d3a8bdb91',
                    // default formId value when Configuration FreshdeskAPI -> Value4 is not configured
                    formId: 'c822d616-dce1-4671-a5ac-a9c3cadb5c2d',
                },
                async mounted() {
                    $("#gridContainer").hide();
                    let freshdeskConfig = await this.getFreshdeskConfig();
                    if (freshdeskConfig) {
                        let baseUrl = freshdeskConfig.im360_value;
                        Global_zendeskBaseUrl = baseUrl;
                        console.log(`Zendesk Dashboard - Global_zendeskBaseUrl from FreshdeskAPI configuration: ${Global_zendeskBaseUrl}`);
                        let funcCode = freshdeskConfig.im360_value2;
                        let funcCodeArr = funcCode.toString().split(';;;;');
                        let firstFuncCode = funcCodeArr[0];
                        let userSettings = Xrm && Xrm.Utility && Xrm.Utility.getGlobalContext() && Xrm.Utility.getGlobalContext().userSettings;
                        let userName = userSettings && userSettings.userName;
                        Global_freshdeskUrl = `${Global_zendeskBaseUrl}/getDataById?code=${firstFuncCode}&category=tickets&userName=${userName}&itemId=`;
                        console.log(`Global_freshdeskUrl: ${Global_freshdeskUrl}`);
                        Global_funcCodeForJsonById = funcCodeArr[3];

                        let im360_value3 = freshdeskConfig.im360_value3;
                        if (im360_value3) {
                            this.appId = im360_value3;
                            console.log(`Zendesk Dashboard - appId from FreshdeskAPI configuration: ${this.appId}`);
                        }

                        let im360_value4 = freshdeskConfig.im360_value4;
                        if (im360_value4) {
                            this.formId = im360_value4;
                            console.log(`Zendesk Dashboard - formId from FreshdeskAPI configuration: ${this.formId}`);
                        }
                    } else {
                        console.error(`Zendesk Dashboard - freshdeskConfig is null`);
                    }

                    if (Global_freshdeskUrl) {
                        console.log(`Zendesk Dashboard - Global_freshdeskUrl: ${Global_freshdeskUrl}`);

                        let stageApi1 = 'crm-zendesk-api.azurewebsites.net';
                        let stageApi2 = 'crm-zendesk-api-dev.azurewebsites.net';
                        let stageApi3 = 'crm-zendesk-api-uat.azurewebsites.net';
                        if ((Global_freshdeskUrl.indexOf(stageApi1) > -1) || (Global_freshdeskUrl.indexOf(stageApi2) > -1) || (Global_freshdeskUrl.indexOf(stageApi3) > -1)) {
                            isStage = true;
                        } else {
                            isStage = false;
                        }
                        // await new Promise(resolve => setTimeout(resolve, 1000)); // wait 1 second to ensure the localStorage variables are updated

                        Global_country_name = localStorage.getItem('zendesk_country_name');
                        Global_im360_bcn = localStorage.getItem('zendesk_im360_bcn');
                        Global_im360_armid = localStorage.getItem('zendesk_im360_armid');
                        
                        this.generateDatagrid(this.getTickets);

                        // to be tested: to see if this is the proper place for the following two lines:
                        setTimeout(() => {
                            localStorage.setItem('zendesk_country_name', '');
                            localStorage.setItem('zendesk_im360_bcn', '')
                        }, 20000);

                    } else {
                        console.error(`Zendesk Dashboard - Zendesk API URL is null`);
                    }
                    $("#gridContainer").show();
                },
                methods: {
                    async getFreshdeskConfig() {
                        let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                         <entity name='im360_configuration'> \
                             <attribute name='im360_value'/> \
                             <attribute name='im360_value2'/> \
                             <attribute name='im360_value3'/> \
                             <attribute name='im360_value4'/> \
                             <filter type='and'> \
                                 <condition attribute='im360_name' operator='eq' value='FreshdeskAPI' /> \
                                 <condition attribute='statuscode' operator='eq' value='1' /> \
                             </filter> \
                         </entity> \
                         </fetch>";

                        return Xrm.WebApi.retrieveMultipleRecords("im360_configuration", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null) {
                                    return result.entities[0];
                                } else {
                                    console.error(`Zendesk Dashboard - Cannot get Zendesk configuration.`);
                                    return null;
                                }
                            },
                            function (error) {
                                console.error(`Zendesk Dashboard - ${error.message}`);
                                return null;
                            }
                        );
                    },

                    async getAccountIdByCountryAndBCN(zendeskCountryName, zendeskBCN) {

                        // BCN logic
                        if (!zendeskBCN || zendeskBCN.toLowerCase() === 'na' || zendeskBCN === '.' || zendeskBCN.toLowerCase() === 'x') {
                            return null;
                        }

                        let bcnFilters = '';
                        const defaultFilter = `<condition attribute='im360_bcn' operator='eq' value='${zendeskBCN}' />`;
                        const defaultFilterCMP = `<condition attribute='im360_armid' operator='like' value='%${zendeskBCN}%' />`;
                        bcnFilters += defaultFilter;
                        bcnFilters += defaultFilterCMP;
                        bcnFilters += defaultFilter.replace(/-/g, "")
                        bcnFilters += defaultFilterCMP.replace(/-/g, "");
                        const defaultFilterWithZero = `<condition attribute='im360_bcn' operator='eq' value='0${zendeskBCN}' />`;
                        bcnFilters += defaultFilterWithZero;
                        bcnFilters += defaultFilterWithZero.replace(/-/g, "");

                        // valid BCN should not contain "-" (only 75 BCNs with "-" on P01, EMEA: 1, APAC: 55, ANZ: 0)
                        const validBcn = zendeskBCN.replace(/-/g, "");
                        const numbersStrArr = validBcn.match(/\d+/g) || [];
                        numbersStrArr.forEach(bcnItem => {
                            let possibleBCN = bcnItem;
                            let possibleBcnFilter = `<condition attribute='im360_bcn' operator='eq' value='${possibleBCN}' />`;
                            bcnFilters += possibleBcnFilter;
                        });

                        // Zendesk ticket: it's possible to save CMP ID (im360_armid) in the BCN field (CMP IDs are all numbers, or numbers with single quote)
                        numbersStrArr.forEach(armIdItem => {
                            let possibleArmId = armIdItem;
                            let possibleArmIdFilter = `<condition attribute='im360_armid' operator='like' value='%${possibleArmId}%' />`;
                            bcnFilters += possibleArmIdFilter;
                        });

                        /* possible BCN value: 
                            50-179892
                            1000008496 | 41880071 | 3002576
                            1000009207 (50708711)
                            1200135560	/ 384738 BERT ROLSTON
                            1200002059 / 178007	Troppus IT & Management (WA)
                            17-178742, 17-178802, 17-178812, 17-178832
                            14-281043 MERCHANT EXPO
                            .IRG PLOTTERS & PRINTERS INC 14-686831
                            Advanced Network Management Inc - Account 20-125586
                            .14-852252
                            308743 / 1200085322 BUSINESS IT SOUTH LIMITED
                            1300062325/AERUMA GROUP SDN BHD
                            "na", "NA"
                            022816
                        */

                        if (zendeskCountryName && zendeskBCN) {
                            let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                                <entity name='account'> \
                                    <attribute name='accountid' /> \
                                    <attribute name='im360_bcn' /> \
                                    <attribute name='im360_armid' /> \
                                    <link-entity name='im360_country' from='im360_countryid' to='im360_country' link-type='inner'> \
                                        <attribute name='im360_name' alias='CountryName' /> \
                                        <filter type='and'> \
                                            <condition attribute='im360_name' operator='eq' value='" + zendeskCountryName + "' /> \
                                        </filter> \
                                    </link-entity> \
                                    <filter type='or'> " + bcnFilters + " </filter> \
                                </entity> \
                                </fetch>";

                            return Xrm.WebApi.retrieveMultipleRecords("account", "?fetchXml=" + fetchXml).then(
                                function success(result) {
                                    if (result != null) {
                                        let finalResult = null;
                                        result.entities.forEach(accountEntity => {
                                            let accountBCN = accountEntity.im360_bcn;
                                            let bcnValid = false;
                                            if (accountBCN) {
                                                accountBCN = accountBCN.trim();
                                                // Zendesk BCN could be a string start with "0", for example, BCN = "022816" (ticket id =24028413) in ANZ Prod
                                                if (zendeskBCN.toLowerCase().indexOf(accountBCN.toLowerCase()) > -1) {
                                                    bcnValid = true;
                                                }
                                                if (zendeskBCN.replace(/-/g, "").toLowerCase().indexOf(accountBCN.toLowerCase()) > -1) {
                                                    bcnValid = true;
                                                }
                                            }

                                            let accountCMPID = accountEntity.im360_armid;
                                            let cmpValid = false;
                                            if (accountCMPID) {
                                                accountCMPID = accountCMPID.trim();
                                                if (zendeskBCN.toLowerCase().indexOf(accountCMPID.toLowerCase()) > -1) {
                                                    cmpValid = true;
                                                }
                                                // IM360 CMP ID possible value (with single quote): '1000003522'
                                                let accountCMPIDWithoutSingleQuote = accountCMPID.replace(/'/g, "");
                                                if (zendeskBCN.replace(/-/g, "").toLowerCase().indexOf(accountCMPIDWithoutSingleQuote.toLowerCase()) > -1) {
                                                    cmpValid = true;
                                                }
                                            }

                                            if (bcnValid || cmpValid) {
                                                finalResult = accountEntity;
                                            }
                                        });

                                        if (finalResult) {
                                            return finalResult;
                                        } else {
                                            console.log (`Zendesk Dashboard - Cannot get valid IM360 account by Zendesk BCN or CMP ID. zendeskBCN: ${zendeskBCN}, fetchXml: ${fetchXml}`)
                                            return null;
                                        }
                                    } else {
                                        console.error(`Zendesk Dashboard - Cannot get Account by Country and BCN. fetchXml: ${fetchXml}`);
                                        return null;
                                    }
                                },
                                function (error) {
                                    console.error(`Zendesk Dashboard - ${error.message}`);
                                    return null;
                                }
                            );
                        } else{
                            return null;
                        }
                    },

                    async getTickets() {
                        let results = [];
                        let bcnFilters = '';
                        let getActiveCountries = this.getActiveCountries;

                        if (Global_country_name) {
                            let countryFilter = `<condition attribute='im360_country' operator='eq' value='${Global_country_name}' />`;
                            let partOfCountryFilter = "<condition attribute='im360_country'";
                            // remove the element that contains the value stored in partOfCountryFilter:
                            Global_finalFilterArr = Global_finalFilterArr.filter(item => !item.includes(partOfCountryFilter));
                            Global_finalFilterArr.push(countryFilter);
                        }

                        /* possible BCN value: 
                            50-179892
                            1000008496 | 41880071 | 3002576
                            1000009207 (50708711)
                            1200135560	/ 384738 BERT ROLSTON
                            1200002059 / 178007	Troppus IT & Management (WA)
                            17-178742, 17-178802, 17-178812, 17-178832
                            14-281043 MERCHANT EXPO
                            .IRG PLOTTERS & PRINTERS INC 14-686831
                            Advanced Network Management Inc - Account 20-125586
                            .14-852252
                            308743 / 1200085322 BUSINESS IT SOUTH LIMITED
                            1300062325/AERUMA GROUP SDN BHD
                            "na", "NA"
                        */
                        if (Global_im360_bcn) {
                            let partOfBcnFilter = "<condition attribute='im360_ingrambcn'";
                            // remove the element that contains the value stored in partOfBcnFilter:
                            Global_finalFilterArr = Global_finalFilterArr.filter(item => !item.includes(partOfBcnFilter));

                            // BCN logic
                            const defaultFilter = `<condition attribute='im360_ingrambcn' operator='like' value='%${Global_im360_bcn}%' />`;
                            bcnFilters += defaultFilter;

                            // if the BCN is not in the Zendesk ticket (only contains CMP ID), when the user type BCN in the IM360 global search box to find the Account, then check the tickets, the tickets will be filtered by BCN or CMP ID, so it'll find that ticket by the account searched.

                            // Error: zendeskBCN is not defined:
                            // const validBcn = zendeskBCN.replace(/-/g, "");
                            // const numbersStrArr = validBcn.match(/\d+/g) || [];
                            // numbersStrArr.forEach(bcnItem => {
                            //     let possibleBCN = bcnItem;
                            //     let possibleFilter = `<condition attribute='im360_ingrambcn' operator='like' value='%${possibleBCN}%' />`;
                            //     bcnFilters += possibleFilter;
                            // });
                        }

                        if (Global_im360_armid) {

                            // CMP ID logic
                            const defaultFilter = `<condition attribute='im360_ingrambcn' operator='like' value='%${Global_im360_armid}%' />`;
                            bcnFilters += defaultFilter;

                            // if the CMP ID is not in the Zendesk ticket (only contains BCN), when the user type CMP ID in the IM360 global search box to find the Account, then check the tickets, the tickets will be filtered by CMP ID, so it'll find that ticket by the account searched.
                        }

                        let bcnFiltersResult = bcnFilters ? `<filter type="or"> ${bcnFilters}</filter>` : '';

                        //let fetchXml = `<fetch top='15'> \
                        let fetchXml = `<fetch> \
                                        <entity name='im360_zendesktickets'> \
                                            <attribute name='im360_ticketid' /> \
                                            <attribute name='im360_name' /> \
                                            <attribute name='im360_country' /> \
                                            <attribute name='im360_created_at' /> \
                                            <attribute name='im360_domain' /> \
                                            <attribute name='im360_ingrambcn' /> \
                                            <attribute name='im360_partneremailaddress' /> \
                                            <attribute name='im360_priority' /> \
                                            <attribute name='im360_resellername' /> \
                                            <attribute name='im360_resolved_at' /> \
                                            <attribute name='im360_resolvehours' /> \
                                            <attribute name='im360_status' /> \
                                            <attribute name='im360_updated_at' /> \
                                            <link-entity name='im360_country' from='im360_name' to='im360_country' alias='country'> \
                                                <attribute name='im360_name' /> \
                                                <filter type='and'> \
                                                    <condition attribute='statecode' operator='eq' value='0' /> \
                                                </filter> \
                                            </link-entity> \
                                            <filter type='and'> ${Global_finalFilterArr.toString().replace(',', '')} \
                                                <condition attribute='im360_domain' operator='ne' value='Sales Esc (Legacy)' /> \
                                                <condition attribute='im360_domain' operator='ne' value='Sales Escï¿½(Legacy)' /> \
                                                <condition attribute='im360_domain' operator='ne' value='MS Escalations (Legacy)' /> \
                                             ${bcnFiltersResult}</filter> \
                                            <order descending='true' attribute='im360_created_at' /> \
                                        </entity> \
                                    </fetch>`;
                            console.log(`Zendesk Dashboard - fetchXml for getTickets(): ${fetchXml}`);

                        try {

                            const result = await Xrm.WebApi.retrieveMultipleRecords("im360_zendesktickets", "?fetchXml=" + fetchXml);

                            // to be tested: to see if this is the proper place for the following two lines:
                            setTimeout(() => {
                                localStorage.setItem('zendesk_country_name', '');
                                localStorage.setItem('zendesk_im360_bcn', '')
                            }, 10000);

                            if (result != null) {
                                let items = result.entities;
                                if (items && items.length > 0) {
                                    items.forEach(item => {
                                        if (item && item.im360_name) {
                                            let itemNew = {
                                                'TicketId': item.im360_ticketid,
                                                'Country': item.im360_country ? item.im360_country : '-',
                                                'Ingram BCN#': item.im360_ingrambcn ? item.im360_ingrambcn : '-',
                                                'Partner email address': item.im360_partneremailaddress ? item.im360_partneremailaddress : '-',
                                                'Reseller Name': item.im360_resellername ? item.im360_resellername : '-',
                                                'Ticket subject line': item.im360_name ? item.im360_name : '-',
                                                'Status': item.im360_status ? item.im360_status : '-',
                                                'Domain': item.im360_domain ? item.im360_domain : '-',
                                                'Priority': item.im360_priority ? item.im360_priority : '-'
                                            };

                                            //console.log(`Zendesk Dashboard - item after adding more fields: ${JSON.stringify(itemNew)}`);
                                            results.push(itemNew);
                                        }
                                    });
                                }
                                // return results;
                            }
                        } catch (err) {
                            console.error("CustomStore load error:", err);
                            throw "Data loading error";
                        }

                        // <condition attribute='im360_ticketid' operator='eq' value='39744' />
                        let partOfTicketFilter = "<condition attribute='im360_ticketid'";
                        Global_finalFilterArr = Global_finalFilterArr.filter(item => item.includes(partOfTicketFilter));
                        let isTicketIdSearch = Global_finalFilterArr.length > 0;

                        if (results.length == 0 && isTicketIdSearch) {
                            Global_ticketSearchFromZendeskAPI = true;
                            const ticketId = Global_finalFilterArr[0].toString().split("value='")[1].split("'")[0];
                            let freshdeskUrlWithTicketId = `${Global_freshdeskUrl}${ticketId}`;
                            console.log (`Zendesk URL to get ticket by id: ${freshdeskUrlWithTicketId}`);

                            try {
                                // get result from Zendesk API
                                const apiResponse = await axios.get(freshdeskUrlWithTicketId);
                                console.log('apiResponse.data:', apiResponse.data);
                                let item = apiResponse.data && apiResponse.data.ticket;
                                // 200 OK
                                if (apiResponse.status === 200) {
                                    if (item && item.id && item.subject && Object.keys(item).length > 0) {
                                        let countryFieldId = isStage ? 31959436739604 : 35138178531732;
                                        const objCountry = item.custom_fields && item.custom_fields.find(item => item.id === countryFieldId);
                                        const countryValue = objCountry ? objCountry.value : '';

                                        let bcnFieldId = isStage ? 21077919616660 : 9213900294676;
                                        const objBCN = item.custom_fields && item.custom_fields.find(item => item.id === bcnFieldId);
                                        const bcnValue = objBCN ? objBCN.value : '';

                                        // reseller name: organization_id

                                        let domainFieldId = isStage ? 31042462931476 : 34698829065236;
                                        const objDomain = item.custom_fields && item.custom_fields.find(item => item.id === domainFieldId);
                                        const domainValue = objDomain ? objDomain.value : '';

                                        let itemNew = {
                                            'TicketId': item.id,
                                            'Country': countryValue ? countryValue : '-',
                                            'Ingram BCN#': bcnValue ? bcnValue : '-',
                                            'Partner email address': item.requester_id ? item.requester_id : '-',
                                            'Reseller Name': item.organization_id ? item.organization_id : '-',
                                            'Ticket subject line': item.subject ? item.subject : '-',
                                            'Status': item.status ? item.status.charAt(0).toUpperCase() + item.status.slice(1) : '-',
                                            'Domain': domainValue ? domainValue : '-',
                                            'Priority': item.priority ? item.priority.charAt(0).toUpperCase() + item.priority.slice(1) : '-',
                                        };

                                        console.log(`ticket retrieved from Zendesk API: ${JSON.stringify(itemNew)}`);
                                        results.push(itemNew);
                                    }
                                }
                            } catch (err) {
                                console.error(`Exception occurred during the Zendesk API call: ${err && err.message}`);
                            } 
                        }

                        return results;
                    },

                    async getActiveCountries() {
                        let fetchXml = "<fetch top='50'> \
                                        <entity name='im360_country'> \
                                            <attribute name='im360_name' /> \
                                            <filter type='and'> \
                                            <condition attribute='statecode' operator='eq' value='0' /> \
                                            </filter> \
                                        </entity> \
                                        </fetch>";

                        let pageTitle = this.pageTitle;
                        return Xrm.WebApi.retrieveMultipleRecords("im360_country", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null) {
                                    return result.entities;
                                } else {
                                    console.error(`${pageTitle} - Cannot get active countries, the fetchXml is: ${fetchXml}`);
                                    return null;
                                }
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                this.hideLoadingPage && this.hideLoadingPage();
                                return null;
                            }
                        );
                    },

                    generateDatagrid(getTickets) {
                        let appId = this.appId;
                        let formId = this.formId;
                        let getAccountIdByCountryAndBCN = this.getAccountIdByCountryAndBCN;
                        let filterColumnForTicketId = this.filterColumnForTicketId;
                        let filterColumn = this.filterColumn;
                        let updateColumnInGridCellForAll = this.updateColumnInGridCellForAll;
                        let updateColumnInGridCell = this.updateColumnInGridCell;
                        let updateColumnInGridCellForCountry = this.updateColumnInGridCellForCountry;
                        let updateColumnInGridCellForEmail = this.updateColumnInGridCellForEmail;
                        let updateColumnInGridCellForReseller = this.updateColumnInGridCellForReseller;
                        let updateColumnInGridCellForDomain = this.updateColumnInGridCellForDomain;
                        let getActiveCountries = this.getActiveCountries;

                        // dataSource: ticketsArr,
                        $("#gridContainer").dxDataGrid({
                            dataSource: new DevExpress.data.CustomStore({
                                key: "TicketId",
                                load: getTickets,
                                // update: (key, values) => {
                                //     // update your local cache (or call server then resolve)
                                //     const item = localCache.find(i => i.id === key);
                                //     Object.assign(item, values);
                                //     return Promise.resolve(); // let the grid continue without forcing a reload
                                // }
                            }),
                            filterPanel: {
                                visible: true
                            },
                            remoteOperations: false,
                            allowColumnReordering: true,
                            rowAlternationEnabled: true,
                            allowColumnResizing: true,
                            columnAutoWidth: true,
                            columnChooser: { enabled: true },
                            columnFixing: { enabled: true },
                            filterRow: { visible: true },
                            headerFilter: { visible: true },
                            editing: { allowUpdating: false, allowEditing: false, allowAdding: false, allowDeleting: false },
                            export: { enabled: true, fileName: `item` },
                            grouping: { contextMenuEnabled: true },
                            groupPanel: { visible: true },
                            hoverStateEnabled: true,
                            loadPanel: { height: 100, width: 200, text: `Loading Data...` },
                            pager: { showInfo: true, infoText: `Page {0}. Total: {1} ({2} items)`, showPageSizeSelector: true, allowedPageSizes: [5, 15, 30] },
                            paging: { pageSize: 15, pageIndex: 0 },
                            searchPanel: { visible: false, width: 240, placeholder: `Search...` },
                            selection: { mode: `single` },
                            sorting: { mode: `multiple` },
                            showBorders: true,
                            showColumnLines: true,
                            showRowLines: true,
                            showScrollbar: true,
                            useNative: false,
                            onInitialized(e) {
                                window.gridInstance = e.component; // store grid reference globally
                            },
                            onContentReady: async function(e) {
                                console.log("Grid is ready");

                                if (Global_ticketSearchFromZendeskAPI) {
                                    Global_ticketSearchFromZendeskAPI = false;
                                    //e.element.hide();

                                    let countryValue = await updateColumnInGridCellForCountry(e.component, Global_zendeskBaseUrl, Global_funcCodeForJsonById, updateColumnInGridCell);

                                    let countryValid = false;
                                    let activeCountries = await getActiveCountries();
                                    if (countryValue && activeCountries) {
                                        activeCountries.forEach(country => {
                                            if (country && country.im360_name && country.im360_name.toLowerCase() == countryValue.toLowerCase()) {
                                                countryValid = true;
                                            }
                                        });
                                    }
                                    if (countryValue && !countryValid) {
                                        // const grid = $("#gridContainer").dxDataGrid("instance");
                                        // const store = grid.getDataSource().store();

                                        let keyStr = '';
                                        const firstRow = e.component.getVisibleRows()[0];
                                        if (firstRow) {
                                            const key = firstRow.key;
                                            keyStr = key && key.toString();
                                        }

                                        setTimeout(() => {
                                            const grid = e.component;
                                            const row = 0;

                                            grid.editCell(row, "Country");

                                            grid.cellValue(row, "Ticket Id", "");
                                            grid.cellValue(row, "Country", "");
                                            grid.cellValue(row, "Ingram BCN#", "");
                                            grid.cellValue(row, "Partner email address", "");
                                            grid.cellValue(row, "Reseller Name", "");
                                            grid.cellValue(row, "Ticket subject line", "");
                                            grid.cellValue(row, "Status", "");
                                            grid.cellValue(row, "Domain", "");
                                            grid.cellValue(row, "Priority", "");

                                            const mode = e.component.option("editing.mode"); // 'cell' | 'row' | 'batch' | 'popup' | 'form'
                                            console.log(mode);  // row

                                            grid.closeEditRow(row);

                                            grid.closeEditCell();
                                            // persist changes (if needed)
                                            grid.saveEditData();

                                            grid.saveEditData(); // commits and closes popup/form
                                            // or
                                            //grid.cancelEditData(); // cancels and closes popup/form

                                        }, 0);
                                        
                                        this.hideLoadingPage && this.hideLoadingPage();

                                        let msg = `The country is "${countryValue}" for the ticket with ticket id "${keyStr}", does not belong to this region`;
                                        Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: msg }).then(
                                            function () { 
                                                //e.element.show();
                                            }
                                        );

                                    } else {
                                        await updateColumnInGridCellForEmail(e.component, Global_zendeskBaseUrl, Global_funcCodeForJsonById, updateColumnInGridCell);
                                        await updateColumnInGridCellForReseller(e.component, Global_zendeskBaseUrl, Global_funcCodeForJsonById, updateColumnInGridCell);
                                        await updateColumnInGridCellForDomain(e.component, Global_zendeskBaseUrl, Global_funcCodeForJsonById, updateColumnInGridCell);
                                        //e.element.show();
                                    }
                                }

                                console.log("updateFirstRowCell function completed");
                            },
                            onOptionChanged(e) {
                                if (e.name != "hoveredElement") {
                                    if (e.name === "columns") {
                                        clearTimeout(window.searchTimer);
                                        window.searchTimer = setTimeout(() => {
                                            e.component.refresh();     // reload data, will retrieve the data again by the new Global_finalFilterArr
                                        }, 800);                       // wait 800ms after user stops typing
                                    }

                                    if (e.value && typeof e.value === "string" && e.value.indexOf("'") > -1) {
                                        // if the user typed text contains single quote, it'll throw "Data loading error"
                                        Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: `The search key word should not contain single quote.` })
                                    } else {
                                        switch (e.fullName) {
                                            case "columns[0].filterValue":
                                                Global_finalFilterArr = filterColumnForTicketId('Ticket Id', e.value, Global_finalFilterArr);
                                                break;
                                            case "columns[1].filterValue":
                                                Global_finalFilterArr = filterColumn('Country', e.value, Global_finalFilterArr, 'im360_country');
                                                break;
                                            case "columns[2].filterValue":
                                                Global_finalFilterArr = filterColumn('Ingram BCN#', e.value, Global_finalFilterArr, 'im360_ingrambcn');
                                                break;
                                            case "columns[3].filterValue":
                                                Global_finalFilterArr = filterColumn('Partner email address', e.value, Global_finalFilterArr, 'im360_partneremailaddress');
                                                break;
                                            case "columns[4].filterValue":
                                                Global_finalFilterArr = filterColumn('Reseller Name', e.value, Global_finalFilterArr, 'im360_resellername');
                                                break;
                                            case "columns[5].filterValue":
                                                Global_finalFilterArr = filterColumn('Ticket subject line', e.value, Global_finalFilterArr, 'im360_name');
                                                break;
                                            case "columns[6].filterValue":
                                                Global_finalFilterArr = filterColumn('Status', e.value, Global_finalFilterArr, 'im360_status');
                                                break;
                                            case "columns[7].filterValue":
                                                Global_finalFilterArr = filterColumn('Domain', e.value, Global_finalFilterArr, 'im360_domain');
                                                break;
                                            case "columns[8].filterValue":
                                                Global_finalFilterArr = filterColumn('Priority', e.value, Global_finalFilterArr, 'im360_priority');
                                                break;
                                        }
                                    }

                                    // // global search:
                                    // if (e.name === "searchPanel" && e.fullName === "searchPanel.text") {
                                    //     console.log("User global search value changed:", e.value);
                                    // }
                                }
                            },
                            onRowClick: async function (e) {
                                let data = e.data; // selectedItems.selectedRowsData[0];
                                console.log(`Zendesk Dashboard - onRowClick -> data: ${JSON.stringify(data)}`);
                                
                                let zendeskCountryName = data['Country'];
                                let zendeskBCN = data['Ingram BCN#'];
                                let ticketId = data.TicketId;
                                if (zendeskCountryName && zendeskCountryName != '-' && zendeskBCN && zendeskBCN != '-') {
                                    let accountData = await getAccountIdByCountryAndBCN(zendeskCountryName, zendeskBCN);
                                    /*let accountId = '8e70a94a-9a02-e911-a961-000d3a30e34c';*/
                                    let accountId = accountData ? accountData.accountid : '';
                                    console.log(`Zendesk Dashboard - onRowClick -> accountId: ${accountId}`);

                                    let url = window.location.protocol + "//" + window.location.host + "/";
                                    let fieldName = 'im360_newnavigationtab';
                                    let tabName = 'tab_freshdesk';
                                    let selectedResellerId = data['Ingram BCN#'];

                                    if (accountId) {
                                        let fullUrl = `${url}/main.aspx?appid=${appId}&forceUCI=1&pagetype=entityrecord&etn=account&id=${accountId}&formid=${formId}&extraqs=${fieldName}%3D${tabName}_${ticketId}_${selectedResellerId}`;
                                        console.log(`Zendesk Dashboard - fullUrl: ${fullUrl}`);
                                        localStorage.setItem('zendesk_ticketId', ticketId);
                                        //await new Promise(resolve => setTimeout(resolve, 1000)); // wait 1 second to ensure the localStorage variable is updated
                                        window.open(fullUrl, '_blank');
                                    } else {
                                        Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: `Cannot get Account Id by Country and BCN. Unable to load account details. [ticket id: ${ticketId}]` });
                                    }
                                } else {
                                    Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: `Country or BCN is not available. Unable to load account details. [ticket id: ${ticketId}]` });
                                }
                                return null;
                            }
                        });
                    },

                    async updateColumnInGridCellForCountry (grid, Global_zendeskBaseUrl, Global_funcCodeForJsonById, updateColumnInGridCell) {
                        let fieldName = 'im360_name';
                        
                        // Country:
                        let columnName = "Country";
                        let countryFieldId = isStage ? 31959436739604 : 35138178531732;
                        let countryName = await updateColumnInGridCell(fieldName, grid, columnName, countryFieldId, Global_zendeskBaseUrl, Global_funcCodeForJsonById);
                        return countryName;
                    },

                    async updateColumnInGridCellForEmail (grid, Global_zendeskBaseUrl, Global_funcCodeForJsonById, updateColumnInGridCell) {
                        let fieldName = 'im360_name';
                        
                        // Partner email address (requester_id):
                        columnName = "Partner email address";
                        let emailFieldId = '';
                        await updateColumnInGridCell(fieldName, grid, columnName, emailFieldId, Global_zendeskBaseUrl, Global_funcCodeForJsonById);
                    },

                    async updateColumnInGridCellForReseller (grid, Global_zendeskBaseUrl, Global_funcCodeForJsonById, updateColumnInGridCell) {
                        let fieldName = 'im360_name';

                        // Reseller Name (organization_id):
                        columnName = "Reseller Name";
                        let resellerFieldId = '';
                        await updateColumnInGridCell(fieldName, grid, columnName, resellerFieldId, Global_zendeskBaseUrl, Global_funcCodeForJsonById);
                    },

                    async updateColumnInGridCellForDomain (grid, Global_zendeskBaseUrl, Global_funcCodeForJsonById, updateColumnInGridCell) {
                        let fieldName = 'im360_name';

                        // Domain:
                        columnName = "Domain";
                        let domainFieldId = isStage ? 31042462931476 : 34698829065236;
                        return updateColumnInGridCell(fieldName, grid, columnName, domainFieldId, Global_zendeskBaseUrl, Global_funcCodeForJsonById);
                    },

                    async updateColumnInGridCell(fieldName, grid, columnName, fieldId, Global_zendeskBaseUrl, Global_funcCodeForJsonById) {
                        let firstRowKey = grid.getKeyByRowIndex(0);
                        if (!firstRowKey) return; // grid might be empty (the ticket id value user typed)
                        let configName = '';

                        let fieldValue = grid.cellValue(0, columnName);
                        if (fieldValue && fieldValue != '-') {
                            const fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                                <entity name='im360_zendeskconfig'> \
                                    <attribute name='im360_name' /> \
                                    <filter type='and'> \
                                        <condition attribute='im360_value' operator='eq' value='" + fieldValue + "' /> \
                                        <condition attribute='im360_category' operator='eq' value='ticket_fields' /> \
                                    </filter> \
                                </entity> \
                                </fetch>";

                            const result = await Xrm.WebApi.retrieveMultipleRecords("im360_zendeskconfig", "?fetchXml=" + fetchXml);
                            if (result != null && result.entities && result.entities.length > 0) {
                                let zendeskConfig = result.entities[0];
                                if (zendeskConfig) {
                                    configName = zendeskConfig[fieldName];
                                }

                            } else {
                                // get value from Zendesk API (through Azure Functions)
                                let jsonId = fieldId;
                                let jsonPath = 'ticket_fields';
                                if (columnName === "Partner email address") {
                                    jsonPath = 'users';
                                }
                                if (columnName === "Reseller Name") {
                                    jsonPath = 'organizations';
                                }
                                let fieldData = '';

                                try {
                                    if (jsonPath === 'ticket_fields') {
                                        const url = `${Global_zendeskBaseUrl}/getJsonById?jsonPath=${jsonPath}&jsonId=${jsonId}&code=${Global_funcCodeForJsonById}`;
                                        const fieldDataResult = await axios.get(url);
                                        let fieldData = fieldDataResult ? await fieldDataResult.data : '';
                                        if (fieldData && fieldData.ticket_field && fieldData.ticket_field.custom_field_options) {
                                            const obj = fieldData.ticket_field.custom_field_options.find(item => item.value === fieldValue);
                                            configName = obj ? obj.name : fieldValue;
                                        } else {
                                            configName = '';
                                        }
                                        configName = configName ? configName.trim() : '';
                                    }

                                    if (jsonPath === 'users') {
                                        const url = `${Global_zendeskBaseUrl}/getJsonById?jsonPath=${jsonPath}&jsonId=${fieldValue}&code=${Global_funcCodeForJsonById}`;
                                        const fieldDataResult = await axios.get(url);
                                        let fieldData = fieldDataResult ? await fieldDataResult.data : '';
                                        if (fieldData && fieldData.user) {
                                            configName = fieldData.user.email;
                                        } else {
                                            configName = '';
                                        }
                                        configName = configName ? configName.trim() : '';
                                    }

                                    if (jsonPath === 'organizations') {
                                        const url = `${Global_zendeskBaseUrl}/getJsonById?jsonPath=${jsonPath}&jsonId=${fieldValue}&code=${Global_funcCodeForJsonById}`;
                                        const fieldDataResult = await axios.get(url);
                                        let fieldData = fieldDataResult ? await fieldDataResult.data : '';
                                        if (fieldData && fieldData.organization) {
                                            configName = fieldData.organization.name;
                                        } else {
                                            configName = '';
                                        }
                                        configName = configName ? configName.trim() : '';
                                    }
                                } catch (e) {
                                    console.error(`Zendesk Dashboard - getJsonById error for jsonId ${jsonId} ${fieldValue}: ${e && e.message}`);
                                }

                            }
                            grid.editCell(0, columnName);
                            grid.cellValue(0, columnName, configName);
                            grid.closeEditCell();
                            return configName;
                        }
                    },

                    filterColumn (searchName, searchValue, filterArr, fieldName) {
                        let filter = `<condition attribute='${fieldName}' operator='like' value='%${searchValue}%' />`;
                        let partOfFilter = `<condition attribute='${fieldName}'`;
                        filterArr = filterArr.filter(item => !item.includes(partOfFilter));
                        if (searchValue) {
                            filterArr.push(filter);
                        }
                        console.log(`User column search value changed for ${searchName}:, ${searchValue}`);
                        return filterArr;
                    },

                    filterColumnForTicketId (searchName, searchValue, filterArr) {
                        let filter = `<condition attribute='im360_ticketid' operator='eq' value='${searchValue}' />`;
                        let partOfFilter = "<condition attribute='im360_ticketid'";
                        filterArr = filterArr.filter(item => !item.includes(partOfFilter));
                        if (searchValue) {
                            filterArr.push(filter);
                        }
                        console.log(`User column search value changed for ${searchName}:, ${searchValue}`);
                        return filterArr;
                    }
                }
                
            });
        </script>


        <style scoped>
            body {
                height: 100%;
                -moz-osx-font-smoothing: grayscale;
                -webkit-font-smoothing: antialiased;
                font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica Neue, Helvetica, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial, sans-serif;
            }

            .datagrid {
                margin: 10px 20px 10px 20px;
            }

            .dx-checkbox-container {
                height: 25px;
            }

            .min-col-bcn {
                min-width: 156px;
            }
        </style>

    </body>

</html>
