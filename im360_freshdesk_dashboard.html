<!DOCTYPE html>
<html>

<head>
    <script src="ClientGlobalContext.js.aspx"></script>
    <script src="im360_common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/jquery@3.1.1/dist/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.2.0/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui@2.2.0/lib/index.js"></script>

    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/20.2.7/css/dx.common.css">
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/20.2.7/css/dx.light.css">
    <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/20.2.7/js/dx.web.js"></script>
</head>

    <body>
        <div id="app" class='datagrid'>
            <div title="Click a row to view the ticket's detail tab.">
              <div id="gridContainer"></div>
            </div>
        </div>

        <script>
            let isStage = true;
            let Global_zendeskBaseUrl = '';
            let Global_freshdeskUrl = '';
            let Global_funcCodeForJsonById = '';
            let Global_finalFilterArr = ["<condition attribute='im360_created_at' operator='gt' value='1989-01-01 ' />"];

            let Global_country_name = '';
            let Global_im360_bcn = '';
            let Global_im360_armid = '';

            let app = new Vue({
                el: '#app',
                data: {
                    Global_freshdeskUrl: '',
                    // default appId value when Configuration FreshdeskAPI -> Value3 is not configured
                    appId: '80ffd75d-69ec-ea11-a817-000d3a8bdb91',
                    // default formId value when Configuration FreshdeskAPI -> Value4 is not configured
                    formId: 'c822d616-dce1-4671-a5ac-a9c3cadb5c2d',
                },
                async mounted() {
                    $("#gridContainer").hide();
                    let freshdeskConfig = await this.getFreshdeskConfig();
                    if (freshdeskConfig) {
                        let baseUrl = freshdeskConfig.im360_value;
                        Global_zendeskBaseUrl = baseUrl;
                        console.log(`Zendesk Dashboard - Global_zendeskBaseUrl from FreshdeskAPI configuration: ${Global_zendeskBaseUrl}`);
                        let funcCode = freshdeskConfig.im360_value2;
                        let funcCodeArr = funcCode.toString().split(';;;;');
                        let firstFuncCode = funcCodeArr[0];
                        let userSettings = Xrm && Xrm.Utility && Xrm.Utility.getGlobalContext() && Xrm.Utility.getGlobalContext().userSettings;
                        let userName = userSettings && userSettings.userName;
                        Global_freshdeskUrl = `${Global_zendeskBaseUrl}/getDataById?code=${firstFuncCode}&category=tickets&userName=${userName}&itemId=`;
                        console.log(`Global_freshdeskUrl: ${Global_freshdeskUrl}`);
                        Global_funcCodeForJsonById = funcCodeArr[3];

                        let im360_value3 = freshdeskConfig.im360_value3;
                        if (im360_value3) {
                            this.appId = im360_value3;
                            console.log(`Zendesk Dashboard - appId from FreshdeskAPI configuration: ${this.appId}`);
                        }

                        let im360_value4 = freshdeskConfig.im360_value4;
                        if (im360_value4) {
                            this.formId = im360_value4;
                            console.log(`Zendesk Dashboard - formId from FreshdeskAPI configuration: ${this.formId}`);
                        }
                    } else {
                        console.error(`Zendesk Dashboard - freshdeskConfig is null`);
                    }

                    if (Global_freshdeskUrl) {
                        console.log(`Zendesk Dashboard - Global_freshdeskUrl: ${Global_freshdeskUrl}`);

                        let stageApi1 = 'crm-zendesk-api.azurewebsites.net';
                        let stageApi2 = 'crm-zendesk-api-dev.azurewebsites.net';
                        let stageApi3 = 'crm-zendesk-api-uat.azurewebsites.net';
                        if ((Global_freshdeskUrl.indexOf(stageApi1) > -1) || (Global_freshdeskUrl.indexOf(stageApi2) > -1) || (Global_freshdeskUrl.indexOf(stageApi3) > -1)) {
                            isStage = true;
                        } else {
                            isStage = false;
                        }
                        // await new Promise(resolve => setTimeout(resolve, 1000)); // wait 1 second to ensure the localStorage variables are updated

                        Global_country_name = localStorage.getItem('zendesk_country_name');
                        Global_im360_bcn = localStorage.getItem('zendesk_im360_bcn');
                        Global_im360_armid = localStorage.getItem('zendesk_im360_armid');
                        
                        this.generateDatagrid(this.getTickets);

                    } else {
                        console.error(`Zendesk Dashboard - Zendesk API URL is null`);
                    }
                    $("#gridContainer").show();
                },
                methods: {
                    async getFreshdeskConfig() {
                        let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                         <entity name='im360_configuration'> \
                             <attribute name='im360_value'/> \
                             <attribute name='im360_value2'/> \
                             <attribute name='im360_value3'/> \
                             <attribute name='im360_value4'/> \
                             <filter type='and'> \
                                 <condition attribute='im360_name' operator='eq' value='FreshdeskAPI' /> \
                                 <condition attribute='statuscode' operator='eq' value='1' /> \
                             </filter> \
                         </entity> \
                         </fetch>";

                        return Xrm.WebApi.retrieveMultipleRecords("im360_configuration", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null) {
                                    return result.entities[0];
                                } else {
                                    console.error(`Zendesk Dashboard - Cannot get Zendesk configuration.`);
                                    return null;
                                }
                            },
                            function (error) {
                                console.error(`Zendesk Dashboard - ${error.message}`);
                                return null;
                            }
                        );
                    },

                    async getAccountIdByCountryAndBCN(zendeskCountryName, zendeskBCN) {

                        /* possible BCN value: 
                            50-179892
                            1000008496 | 41880071 | 3002576
                            1000009207 (50708711)
                            1200135560	/ 384738 BERT ROLSTON
                            1200002059 / 178007	Troppus IT & Management (WA)
                            17-178742, 17-178802, 17-178812, 17-178832
                            14-281043 MERCHANT EXPO
                            .IRG PLOTTERS & PRINTERS INC 14-686831
                            Advanced Network Management Inc - Account 20-125586
                            .14-852252
                            308743 / 1200085322 BUSINESS IT SOUTH LIMITED
                            1300062325/AERUMA GROUP SDN BHD
                            "na", "NA"
                            022816
                        */

                        // BCN logic
                        if (!zendeskBCN || zendeskBCN.toLowerCase() === 'na' || zendeskBCN === '.' || zendeskBCN.toLowerCase() === 'x' || zendeskBCN.trim() === '' || zendeskBCN.trim().length < 4) {
                            return null;
                        }

                        let bcnFilters = '';
                        const defaultFilter = `<condition attribute='im360_bcn' operator='eq' value='${zendeskBCN}' />`;
                        const defaultFilterCMP = `<condition attribute='im360_armid' operator='like' value='%${zendeskBCN}%' />`;
                        bcnFilters += defaultFilter;
                        bcnFilters += defaultFilterCMP;
                        bcnFilters += defaultFilter.replace(/-/g, "")
                        bcnFilters += defaultFilterCMP.replace(/-/g, "");
                        const defaultFilterWithZero = `<condition attribute='im360_bcn' operator='eq' value='0${zendeskBCN}' />`;
                        bcnFilters += defaultFilterWithZero;
                        bcnFilters += defaultFilterWithZero.replace(/-/g, "");

                        // valid BCN should not contain "-" (only 75 BCNs with "-" on P01, EMEA: 1, APAC: 55, ANZ: 0)
                        const validBcn = zendeskBCN.replace(/-/g, "");
                        const numbersStrArr = validBcn.match(/\d+/g) || [];
                        numbersStrArr.forEach(bcnItem => {
                            let possibleBCN = bcnItem;
                            let possibleBcnFilter = `<condition attribute='im360_bcn' operator='eq' value='${possibleBCN}' />`;
                            bcnFilters += possibleBcnFilter;
                        });

                        // Zendesk ticket: it's possible to save CMP ID (im360_armid) in the BCN field (CMP IDs are all numbers, or numbers with single quote)
                        numbersStrArr.forEach(armIdItem => {
                            let possibleArmId = armIdItem;
                            let possibleArmIdFilter = `<condition attribute='im360_armid' operator='like' value='%${possibleArmId}%' />`;
                            bcnFilters += possibleArmIdFilter;
                        });

                        if (zendeskCountryName && zendeskBCN) {
                            let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                                <entity name='account'> \
                                    <attribute name='accountid' /> \
                                    <attribute name='im360_bcn' /> \
                                    <attribute name='im360_armid' /> \
                                    <link-entity name='im360_country' from='im360_countryid' to='im360_country' link-type='inner'> \
                                        <attribute name='im360_name' alias='CountryName' /> \
                                        <filter type='and'> \
                                            <condition attribute='im360_name' operator='eq' value='" + zendeskCountryName + "' /> \
                                        </filter> \
                                    </link-entity> \
                                    <filter type='or'> " + bcnFilters + " </filter> \
                                </entity> \
                                </fetch>";

                            return Xrm.WebApi.retrieveMultipleRecords("account", "?fetchXml=" + fetchXml).then(
                                function success(result) {
                                    if (result != null) {
                                        let finalResult = null;
                                        let totalResults = 0;
                                        if (result.entities) {
                                            result.entities.forEach(accountEntity => {
                                            let accountBCN = accountEntity.im360_bcn;
                                            let bcnValid = false;
                                            if (accountBCN) {
                                                accountBCN = accountBCN.trim();
                                                // Zendesk BCN could be a string start with "0", for example, BCN = "022816" (ticket id =24028413) in ANZ Prod
                                                if (zendeskBCN.toLowerCase().indexOf(accountBCN.toLowerCase()) > -1) {
                                                    bcnValid = true;
                                                }
                                                if (zendeskBCN.replace(/-/g, "").toLowerCase().indexOf(accountBCN.toLowerCase()) > -1) {
                                                    bcnValid = true;
                                                }
                                            }

                                            let accountCMPID = accountEntity.im360_armid;
                                            let cmpValid = false;
                                            if (accountCMPID) {
                                                accountCMPID = accountCMPID.trim();
                                                if (zendeskBCN.toLowerCase().indexOf(accountCMPID.toLowerCase()) > -1) {
                                                    cmpValid = true;
                                                }
                                                // IM360 CMP ID possible value (with single quote): '1000003522'
                                                let accountCMPIDWithoutSingleQuote = accountCMPID.replace(/'/g, "");
                                                if (zendeskBCN.replace(/-/g, "").toLowerCase().indexOf(accountCMPIDWithoutSingleQuote.toLowerCase()) > -1) {
                                                    cmpValid = true;
                                                }
                                            }

                                            if (bcnValid || cmpValid) {
                                                finalResult = accountEntity;
                                                totalResults += 1;
                                            }
                                        });
                                        }
                                        if (totalResults > 1) {
                                            console.warn(`Zendesk Dashboard - There are ${totalResults} Accounts found for the Country: ${zendeskCountryName} and zendeskBCN: ${zendeskBCN}. Please check if there are duplicate Accounts in CRM. fetchXml: ${fetchXml}`);
                                        }

                                        if (finalResult) {
                                            return finalResult;
                                        } else {
                                            console.log (`Zendesk Dashboard - Cannot get valid IM360 account by Zendesk BCN or CMP ID. zendeskBCN: ${zendeskBCN}, fetchXml: ${fetchXml}`)
                                            return null;
                                        }
                                    } else {
                                        console.error(`Zendesk Dashboard - Cannot get Account by Country and BCN. fetchXml: ${fetchXml}`);
                                        return null;
                                    }
                                },
                                function (error) {
                                    console.error(`Zendesk Dashboard - ${error.message}`);
                                    return null;
                                }
                            );
                        } else{
                            return null;
                        }
                    },

                    async getTickets() {
                        let results = [];
                        let bcnFilters = '';
                        let getActiveCountries = this.getActiveCountries;
                        let getColumnValue = this.getColumnValue;
                        let getValueForCountry = this.getValueForCountry;
                        let getValueForEmail = this.getValueForEmail;
                        let getValueForReseller = this.getValueForReseller;
                        let getValueForDomain = this.getValueForDomain;

                        if (Global_country_name) {
                            let countryFilter = `<condition attribute='im360_country' operator='eq' value='${Global_country_name}' />`;
                            let partOfCountryFilter = "<condition attribute='im360_country'";
                            // remove the element that contains the value stored in partOfCountryFilter:
                            Global_finalFilterArr = Global_finalFilterArr.filter(item => !item.includes(partOfCountryFilter));
                            Global_finalFilterArr.push(countryFilter);
                        }

                        /* possible BCN value: 
                            50-179892
                            1000008496 | 41880071 | 3002576
                            1000009207 (50708711)
                            1200135560	/ 384738 BERT ROLSTON
                            1200002059 / 178007	Troppus IT & Management (WA)
                            17-178742, 17-178802, 17-178812, 17-178832
                            14-281043 MERCHANT EXPO
                            .IRG PLOTTERS & PRINTERS INC 14-686831
                            Advanced Network Management Inc - Account 20-125586
                            .14-852252
                            308743 / 1200085322 BUSINESS IT SOUTH LIMITED
                            1300062325/AERUMA GROUP SDN BHD
                            "na", "NA"
                        */
                        if (Global_im360_bcn) {
                            let partOfBcnFilter = "<condition attribute='im360_ingrambcn'";
                            // remove the element that contains the value stored in partOfBcnFilter:
                            Global_finalFilterArr = Global_finalFilterArr.filter(item => !item.includes(partOfBcnFilter));

                            // BCN logic
                            const defaultFilter = `<condition attribute='im360_ingrambcn' operator='like' value='%${Global_im360_bcn}%' />`;
                            bcnFilters += defaultFilter;

                            // add "-" after the second digits, for example: "41389412" -> "41-389412"
                            if (Global_im360_bcn.length > 2) {
                                let bcnWithDash = Global_im360_bcn.slice(0, 2) + "-" + Global_im360_bcn.slice(2);
                                bcnFilters += `<condition attribute='im360_ingrambcn' operator='like' value='%${bcnWithDash}%' />`;
                            }

                            // if the BCN is not in the Zendesk ticket (only contains CMP ID), when the user type BCN in the IM360 global search box to find the Account, then check the tickets, the tickets will be filtered by BCN or CMP ID, so it'll find that ticket by the account searched.

                            // Error: zendeskBCN is not defined:
                            // const validBcn = zendeskBCN.replace(/-/g, "");
                            // const numbersStrArr = validBcn.match(/\d+/g) || [];
                            // numbersStrArr.forEach(bcnItem => {
                            //     let possibleBCN = bcnItem;
                            //     let possibleFilter = `<condition attribute='im360_ingrambcn' operator='like' value='%${possibleBCN}%' />`;
                            //     bcnFilters += possibleFilter;
                            // });
                        }

                        if (Global_im360_armid) {

                            // CMP ID logic
                            const defaultFilter = `<condition attribute='im360_ingrambcn' operator='like' value='%${Global_im360_armid}%' />`;
                            bcnFilters += defaultFilter;

                            // add "-" after the second digits, for example: "1000003522" -> "10-00003522"
                            let cmpWithDash = Global_im360_armid.slice(0, 2) + "-" + Global_im360_armid.slice(2);
                            bcnFilters += `<condition attribute='im360_ingrambcn' operator='like' value='%${cmpWithDash}%' />`;

                            // if the CMP ID is not in the Zendesk ticket (only contains BCN), when the user type CMP ID in the IM360 global search box to find the Account, then check the tickets, the tickets will be filtered by CMP ID, so it'll find that ticket by the account searched.
                        }

                        let bcnFiltersResult = bcnFilters ? `<filter type="or"> ${bcnFilters}</filter>` : '';

                        //let fetchXml = `<fetch top='15'> \
                        let fetchXml = `<fetch> \
                                        <entity name='im360_zendesktickets'> \
                                            <attribute name='im360_ticketid' /> \
                                            <attribute name='im360_name' /> \
                                            <attribute name='im360_country' /> \
                                            <attribute name='im360_created_at' /> \
                                            <attribute name='im360_domain' /> \
                                            <attribute name='im360_ingrambcn' /> \
                                            <attribute name='im360_partneremailaddress' /> \
                                            <attribute name='im360_priority' /> \
                                            <attribute name='im360_resellername' /> \
                                            <attribute name='im360_resolved_at' /> \
                                            <attribute name='im360_resolvehours' /> \
                                            <attribute name='im360_status' /> \
                                            <attribute name='im360_updated_at' /> \
                                            <link-entity name='im360_country' from='im360_name' to='im360_country' alias='country'> \
                                                <attribute name='im360_name' /> \
                                                <filter type='and'> \
                                                    <condition attribute='statecode' operator='eq' value='0' /> \
                                                </filter> \
                                            </link-entity> \
                                            <filter type='and'> ${Global_finalFilterArr.toString().replace(',', '')} \
                                                <condition attribute='im360_domain' operator='ne' value='Sales Esc (Legacy)' /> \
                                                <condition attribute='im360_domain' operator='ne' value='Sales Escï¿½(Legacy)' /> \
                                                <condition attribute='im360_domain' operator='ne' value='MS Escalations (Legacy)' /> \
                                             ${bcnFiltersResult}</filter> \
                                            <order descending='true' attribute='im360_created_at' /> \
                                        </entity> \
                                    </fetch>`;
                            console.log(`Zendesk Dashboard - fetchXml for getTickets(): ${fetchXml}`);

                        try {

                            const result = await Xrm.WebApi.retrieveMultipleRecords("im360_zendesktickets", "?fetchXml=" + fetchXml);

                            // clear the localStorage variables after using them to filter tickets (need to wait 5 seconds to ensure the data loading is finished, sometimes the data loading twice)
                            setTimeout(() => {
                                localStorage.setItem('zendesk_country_name', '');
                                localStorage.setItem('zendesk_im360_bcn', '');
                                localStorage.setItem('zendesk_im360_armid', '')
                            }, 5000);

                            if (result != null) {
                                let items = result.entities;
                                const filteredItemsBCN = filterExactBCNResults(items, Global_im360_bcn);
                                const filteredItemsCMPID = filterExactBCNResults(items, Global_im360_armid);
                                filteredItems = [...filteredItemsBCN, ...filteredItemsCMPID];

                                if (filteredItems && filteredItems.length > 0) {
                                    filteredItems.forEach(item => {
                                        if (item && item.im360_name) {
                                            let itemNew = {
                                                'TicketId': item.im360_ticketid,
                                                'Country': item.im360_country ? item.im360_country : '-',
                                                'Ingram BCN#': item.im360_ingrambcn ? item.im360_ingrambcn : '-',
                                                'Partner email address': item.im360_partneremailaddress ? item.im360_partneremailaddress : '-',
                                                'Reseller Name': item.im360_resellername ? item.im360_resellername : '-',
                                                'Ticket subject line': item.im360_name ? item.im360_name : '-',
                                                'Status': item.im360_status ? item.im360_status : '-',
                                                'Domain': item.im360_domain ? item.im360_domain : '-',
                                                'Priority': item.im360_priority ? item.im360_priority : '-'
                                            };

                                            //console.log(`Zendesk Dashboard - item after adding more fields: ${JSON.stringify(itemNew)}`);
                                            results.push(itemNew);
                                        }
                                    });
                                }
                                // return results;
                            }
                        } catch (err) {
                            console.error("CustomStore load error:", err);
                            throw "Data loading error";
                        }

                        // <condition attribute='im360_ticketid' operator='eq' value='39744' />
                        let partOfTicketFilter = "<condition attribute='im360_ticketid'";
                        Global_finalFilterArr = Global_finalFilterArr.filter(item => item.includes(partOfTicketFilter));
                        let isTicketIdSearch = Global_finalFilterArr.length > 0;

                        if (results.length == 0 && isTicketIdSearch) {
                            const ticketId = Global_finalFilterArr[0].toString().split("value='")[1].split("'")[0];
                            let freshdeskUrlWithTicketId = `${Global_freshdeskUrl}${ticketId}`;
                            console.log (`Zendesk URL to get ticket by id: ${freshdeskUrlWithTicketId}`);

                            try {
                                // get result from Zendesk API
                                const apiResponse = await axios.get(freshdeskUrlWithTicketId);
                                console.log('apiResponse.data:', apiResponse.data);
                                let item = apiResponse.data && apiResponse.data.ticket;
                                // 200 OK
                                if (apiResponse.status === 200) {
                                    let partnerEmailAddress = '';
                                    let resellerName = '';
                                    let domain = '';

                                    if (item && item.id && item.subject && Object.keys(item).length > 0) {
                                        let countryFieldId = isStage ? 31959436739604 : 35138178531732;
                                        const objCountry = item.custom_fields && item.custom_fields.find(item => item.id === countryFieldId);
                                        const countryValue = objCountry ? objCountry.value : '';

                                        let bcnFieldId = isStage ? 21077919616660 : 9213900294676;
                                        const objBCN = item.custom_fields && item.custom_fields.find(item => item.id === bcnFieldId);
                                        const bcnValue = objBCN ? objBCN.value : '';

                                        let domainFieldId = isStage ? 31042462931476 : 34698829065236;
                                        const objDomain = item.custom_fields && item.custom_fields.find(item => item.id === domainFieldId);
                                        const domainValue = objDomain ? objDomain.value : '';

                                        let countryName = await getValueForCountry(countryValue, Global_zendeskBaseUrl, Global_funcCodeForJsonById, getColumnValue);
                                        let countryValid = false;
                                        let activeCountries = await getActiveCountries();
                                        if (countryName && activeCountries) {
                                            activeCountries.forEach(country => {
                                                if (country && country.im360_name && country.im360_name.toLowerCase() == countryName.toLowerCase()) {
                                                    countryValid = true;
                                                }
                                            });
                                        }
                                        if (countryName && !countryValid) {
                                            let ticketId = item.id;

                                            let msg = `The country is "${countryName}" for the ticket with ticket id "${ticketId}", does not belong to this region`;
                                            Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: msg });
                                        } else {
                                            partnerEmailAddress = await getValueForEmail(item.requester_id, Global_zendeskBaseUrl, Global_funcCodeForJsonById, getColumnValue);
                                            resellerName = await getValueForReseller(item.organization_id, Global_zendeskBaseUrl, Global_funcCodeForJsonById, getColumnValue);
                                            domain = await getValueForDomain(domainValue, Global_zendeskBaseUrl, Global_funcCodeForJsonById, getColumnValue);
                                            let itemNew = {
                                                'TicketId': item.id,
                                                'Country': countryName ? countryName : '-',
                                                'Ingram BCN#': bcnValue ? bcnValue : '-',
                                                'Partner email address': partnerEmailAddress ? partnerEmailAddress : '-',
                                                'Reseller Name': resellerName ? resellerName : '-',
                                                'Ticket subject line': item.subject ? item.subject : '-',
                                                'Status': item.status ? item.status.charAt(0).toUpperCase() + item.status.slice(1) : '-',
                                                'Domain': domain ? domain : '-',
                                                'Priority': item.priority ? item.priority.charAt(0).toUpperCase() + item.priority.slice(1) : '-',
                                            };
                                            results.push(itemNew);
                                            console.log(`Zendesk - ticket retrieved from Zendesk API: ${JSON.stringify(itemNew)}`);
                                        }
                                    }
                                }
                            } catch (err) {
                                console.error(`Exception occurred during the Zendesk API call: ${err && err.message}`);
                            } 
                        }

                        return results;
                    },

                    async getActiveCountries() {
                        let fetchXml = "<fetch top='5000'> \
                                        <entity name='im360_country'> \
                                            <attribute name='im360_name' /> \
                                            <filter type='and'> \
                                            <condition attribute='statecode' operator='eq' value='0' /> \
                                            </filter> \
                                        </entity> \
                                        </fetch>";

                        let pageTitle = this.pageTitle;
                        return Xrm.WebApi.retrieveMultipleRecords("im360_country", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null) {
                                    return result.entities;
                                } else {
                                    console.error(`${pageTitle} - Cannot get active countries, the fetchXml is: ${fetchXml}`);
                                    return null;
                                }
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                this.hideLoadingPage && this.hideLoadingPage();
                                return null;
                            }
                        );
                    },

                    generateDatagrid(getTickets) {
                        let appId = this.appId;
                        let formId = this.formId;
                        let getAccountIdByCountryAndBCN = this.getAccountIdByCountryAndBCN;
                        let filterColumnForTicketId = this.filterColumnForTicketId;
                        let filterColumn = this.filterColumn;

                        // dataSource: ticketsArr,
                        $("#gridContainer").dxDataGrid({
                            dataSource: new DevExpress.data.CustomStore({
                                key: "TicketId",
                                load: getTickets,
                                // update: (key, values) => {
                                //     // update your local cache (or call server then resolve)
                                //     const item = localCache.find(i => i.id === key);
                                //     Object.assign(item, values);
                                //     return Promise.resolve(); // let the grid continue without forcing a reload
                                // }
                            }),
                            filterPanel: {
                                visible: true
                            },
                            remoteOperations: false,
                            allowColumnReordering: true,
                            rowAlternationEnabled: true,
                            allowColumnResizing: true,
                            columnAutoWidth: true,
                            columnChooser: { enabled: true },
                            columnFixing: { enabled: true },
                            filterRow: { visible: true },
                            headerFilter: { visible: true },
                            editing: { allowUpdating: false, allowEditing: false, allowAdding: false, allowDeleting: false },
                            export: { enabled: true, fileName: `item` },
                            grouping: { contextMenuEnabled: true },
                            groupPanel: { visible: true },
                            hoverStateEnabled: true,
                            loadPanel: { height: 100, width: 200, text: `Loading Data...` },
                            pager: { showInfo: true, infoText: `Page {0}. Total: {1} ({2} items)`, showPageSizeSelector: true, allowedPageSizes: [5, 15, 30] },
                            paging: { pageSize: 15, pageIndex: 0 },
                            searchPanel: { visible: false, width: 240, placeholder: `Search...` },
                            selection: { mode: `single` },
                            sorting: { mode: `multiple` },
                            showBorders: true,
                            showColumnLines: true,
                            showRowLines: true,
                            showScrollbar: true,
                            useNative: false,
                            onInitialized(e) {
                                window.gridInstance = e.component; // store grid reference globally
                            },
                            onContentReady: async function(e) {
                                console.log("Grid is ready");
                            },
                            onOptionChanged(e) {
                                if (e.name != "hoveredElement") {
                                    if (e.name === "columns") {
                                        clearTimeout(window.searchTimer);
                                        window.searchTimer = setTimeout(() => {
                                            e.component.refresh();     // reload data, will retrieve the data again by the new Global_finalFilterArr
                                        }, 800);                       // wait 800ms after user stops typing
                                    }

                                    let searchName = '';
                                    let fieldName = '';

                                    if (e.value && typeof e.value === "string" && e.value.indexOf("'") > -1) {
                                        // if the user typed text contains single quote, it'll throw "Data loading error"
                                        Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: `The search key word should not contain single quote.` })
                                    } else {
                                        switch (e.fullName) {
                                            case "columns[0].filterValue":
                                                Global_finalFilterArr = filterColumnForTicketId('Ticket Id', e.value, Global_finalFilterArr);
                                                break;
                                            case "columns[1].filterValue":
                                                searchName = 'Country';
                                                fieldName = 'im360_country';
                                                Global_finalFilterArr = filterColumn(searchName, e.value, Global_finalFilterArr, fieldName);
                                                break;
                                            case "columns[2].filterValue":
                                                searchName = 'Ingram BCN#';
                                                fieldName = 'im360_ingrambcn';
                                                Global_finalFilterArr = filterColumn(searchName, e.value, Global_finalFilterArr, fieldName);
                                                break;
                                            case "columns[3].filterValue":
                                                searchName = 'Partner email address';
                                                fieldName = 'im360_partneremailaddress';
                                                Global_finalFilterArr = filterColumn(searchName, e.value, Global_finalFilterArr, fieldName);
                                                break;
                                            case "columns[4].filterValue":
                                                searchName = 'Reseller Name';
                                                fieldName = 'im360_resellername';
                                                Global_finalFilterArr = filterColumn(searchName, e.value, Global_finalFilterArr, fieldName);
                                                break;
                                            case "columns[5].filterValue":
                                                searchName = 'Ticket subject line';
                                                fieldName = 'im360_name';
                                                Global_finalFilterArr = filterColumn(searchName, e.value, Global_finalFilterArr, fieldName);
                                                break;
                                            case "columns[6].filterValue":
                                                searchName = 'Status';
                                                fieldName = 'im360_status';
                                                Global_finalFilterArr = filterColumn(searchName, e.value, Global_finalFilterArr, fieldName);
                                                break;
                                            case "columns[7].filterValue":
                                                searchName = 'Domain';
                                                fieldName = 'im360_domain';
                                                Global_finalFilterArr = filterColumn(searchName, e.value, Global_finalFilterArr, fieldName);
                                                break;
                                            case "columns[8].filterValue":
                                                searchName = 'Priority';
                                                fieldName = 'im360_priority';
                                                Global_finalFilterArr = filterColumn(searchName, e.value, Global_finalFilterArr, fieldName);
                                                break;
                                        }
                                    }

                                    // // global search:
                                    // if (e.name === "searchPanel" && e.fullName === "searchPanel.text") {
                                    //     console.log("User global search value changed:", e.value);
                                    // }
                                }
                            },
                            onRowClick: async function (e) {
                                let data = e.data; // selectedItems.selectedRowsData[0];
                                console.log(`Zendesk Dashboard - onRowClick -> data: ${JSON.stringify(data)}`);
                                
                                let zendeskCountryName = data['Country'];
                                let zendeskBCN = data['Ingram BCN#'];
                                let ticketId = data.TicketId;
                                if (zendeskCountryName && zendeskCountryName != '-' && zendeskBCN && zendeskBCN != '-') {
                                    let accountData = await getAccountIdByCountryAndBCN(zendeskCountryName, zendeskBCN);
                                    /*let accountId = '8e70a94a-9a02-e911-a961-000d3a30e34c';*/
                                    let accountId = accountData ? accountData.accountid : '';
                                    console.log(`Zendesk Dashboard - onRowClick -> accountId: ${accountId}`);

                                    let url = window.location.protocol + "//" + window.location.host + "/";
                                    let fieldName = 'im360_newnavigationtab';
                                    let tabName = 'tab_freshdesk';
                                    let selectedResellerId = data['Ingram BCN#'];

                                    if (accountId) {
                                        let fullUrl = `${url}/main.aspx?appid=${appId}&forceUCI=1&pagetype=entityrecord&etn=account&id=${accountId}&formid=${formId}&extraqs=${fieldName}%3D${tabName}_${ticketId}_${selectedResellerId}`;
                                        console.log(`Zendesk Dashboard - fullUrl: ${fullUrl}`);
                                        localStorage.setItem('zendesk_ticketId', ticketId);
                                        //await new Promise(resolve => setTimeout(resolve, 1000)); // wait 1 second to ensure the localStorage variable is updated
                                        window.open(fullUrl, '_blank');
                                    } else {
                                        Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: `Cannot get Account Id by Country and BCN. Unable to load account details. [ticket id: ${ticketId}]` });
                                    }
                                } else {
                                    Xrm.Navigation.openAlertDialog({ confirmButtonLabel: "OK", text: `Country or BCN is not available. Unable to load account details. [ticket id: ${ticketId}]` });
                                }
                                return null;
                            }
                        });
                    },

                    async getValueForCountry (fieldValue, Global_zendeskBaseUrl, Global_funcCodeForJsonById, getColumnValue) {
                        let fieldName = 'im360_name';
                        
                        // Country:
                        let columnName = "Country";
                        let countryFieldId = isStage ? 31959436739604 : 35138178531732;
                        let countryName = await getColumnValue(fieldName, fieldValue, columnName, countryFieldId, Global_zendeskBaseUrl, Global_funcCodeForJsonById);
                        return countryName;
                    },

                    async getValueForEmail (fieldValue, Global_zendeskBaseUrl, Global_funcCodeForJsonById, getColumnValue) {
                        let fieldName = 'im360_name';
                        
                        // Partner email address (requester_id):
                        columnName = "Partner email address";
                        let emailFieldId = '';
                        let partnerEmailAddress = await getColumnValue(fieldName, fieldValue, columnName, emailFieldId, Global_zendeskBaseUrl, Global_funcCodeForJsonById);
                        return partnerEmailAddress;
                    },

                    async getValueForReseller (fieldValue, Global_zendeskBaseUrl, Global_funcCodeForJsonById, getColumnValue) {
                        let fieldName = 'im360_name';

                        // Reseller Name (organization_id):
                        columnName = "Reseller Name";
                        let resellerFieldId = '';
                        let resellerName = await getColumnValue(fieldName, fieldValue, columnName, resellerFieldId, Global_zendeskBaseUrl, Global_funcCodeForJsonById);
                        return resellerName;
                    },

                    async getValueForDomain (fieldValue, Global_zendeskBaseUrl, Global_funcCodeForJsonById, getColumnValue) {
                        let fieldName = 'im360_name';

                        // Domain:
                        columnName = "Domain";
                        let domainFieldId = isStage ? 31042462931476 : 34698829065236;
                        let domainName = await getColumnValue(fieldName, fieldValue, columnName, domainFieldId, Global_zendeskBaseUrl, Global_funcCodeForJsonById);
                        return domainName;
                    },

                    async getColumnValue(fieldName, fieldValue, columnName, fieldId, Global_zendeskBaseUrl, Global_funcCodeForJsonById) {
                        let configName = '';

                        if (fieldValue && fieldValue != '-') {
                            const fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                                <entity name='im360_zendeskconfig'> \
                                    <attribute name='im360_name' /> \
                                    <filter type='and'> \
                                        <condition attribute='im360_value' operator='eq' value='" + fieldValue + "' /> \
                                        <condition attribute='im360_category' operator='eq' value='ticket_fields' /> \
                                    </filter> \
                                </entity> \
                                </fetch>";

                            const result = await Xrm.WebApi.retrieveMultipleRecords("im360_zendeskconfig", "?fetchXml=" + fetchXml);
                            if (result != null && result.entities && result.entities.length > 0) {
                                let zendeskConfig = result.entities[0];
                                if (zendeskConfig) {
                                    configName = zendeskConfig[fieldName];
                                }

                            } else {
                                // get value from Zendesk API (through Azure Functions)
                                let jsonId = fieldId;
                                let jsonPath = 'ticket_fields';
                                if (columnName === "Partner email address") {
                                    jsonPath = 'users';
                                }
                                if (columnName === "Reseller Name") {
                                    jsonPath = 'organizations';
                                }
                                let fieldData = '';

                                try {
                                    if (jsonPath === 'ticket_fields') {
                                        const url = `${Global_zendeskBaseUrl}/getJsonById?jsonPath=${jsonPath}&jsonId=${jsonId}&code=${Global_funcCodeForJsonById}`;
                                        const fieldDataResult = await axios.get(url);
                                        let fieldData = fieldDataResult ? await fieldDataResult.data : '';
                                        if (fieldData && fieldData.ticket_field && fieldData.ticket_field.custom_field_options) {
                                            const obj = fieldData.ticket_field.custom_field_options.find(item => item.value === fieldValue);
                                            configName = obj ? obj.name : fieldValue;
                                        } else {
                                            configName = '';
                                        }
                                        configName = configName ? configName.trim() : '';
                                    }

                                    if (jsonPath === 'users') {
                                        const url = `${Global_zendeskBaseUrl}/getJsonById?jsonPath=${jsonPath}&jsonId=${fieldValue}&code=${Global_funcCodeForJsonById}`;
                                        const fieldDataResult = await axios.get(url);
                                        let fieldData = fieldDataResult ? await fieldDataResult.data : '';
                                        if (fieldData && fieldData.user) {
                                            configName = fieldData.user.email;
                                        } else {
                                            configName = '';
                                        }
                                        configName = configName ? configName.trim() : '';
                                    }

                                    if (jsonPath === 'organizations') {
                                        const url = `${Global_zendeskBaseUrl}/getJsonById?jsonPath=${jsonPath}&jsonId=${fieldValue}&code=${Global_funcCodeForJsonById}`;
                                        const fieldDataResult = await axios.get(url);
                                        let fieldData = fieldDataResult ? await fieldDataResult.data : '';
                                        if (fieldData && fieldData.organization) {
                                            configName = fieldData.organization.name;
                                        } else {
                                            configName = '';
                                        }
                                        configName = configName ? configName.trim() : '';
                                    }
                                } catch (e) {
                                    console.error(`Zendesk Dashboard - getJsonById error for jsonId ${jsonId} ${fieldValue}: ${e && e.message}`);
                                }

                            }
                            // grid.editCell(0, columnName);
                            // grid.cellValue(0, columnName, configName);
                            // grid.closeEditCell();
                            return configName;
                        }
                    },

                    filterColumn (searchName, searchValue, filterArr, fieldName) {
                        let filter = `<condition attribute='${fieldName}' operator='like' value='%${searchValue}%' />`;
                        let partOfFilter = `<condition attribute='${fieldName}'`;
                        filterArr = filterArr.filter(item => !item.includes(partOfFilter));
                        if (searchValue) {
                            filterArr.push(filter);
                        }
                        console.log(`User column search value changed for ${searchName}:, ${searchValue}`);
                        return filterArr;
                    },

                    filterColumnForTicketId (searchName, searchValue, filterArr) {
                        let filter = `<condition attribute='im360_ticketid' operator='eq' value='${searchValue}' />`;
                        let partOfFilter = "<condition attribute='im360_ticketid'";
                        filterArr = filterArr.filter(item => !item.includes(partOfFilter));
                        if (searchValue) {
                            filterArr.push(filter);
                        }
                        console.log(`User column search value changed for ${searchName}:, ${searchValue}`);
                        return filterArr;
                    }
                }
                
            });

            const extractBCNTokens = (value) => {
                if (!value) return [];

                // Extract tokens: letters+digits with optional hyphens, â¥4 characters
                return value
                    .match(/[A-Za-z0-9][A-Za-z0-9-]{3,}/g)          // find tokens
                    ?.map(x => x.replace(/-/g, "").toUpperCase())   // normalize
                    || [];
            };

            const filterExactBCNResults = (records, bcnRaw) => {
                if (!bcnRaw || bcnRaw.trim() === "") {
                    return records;
                }
                const validTokens = extractBCNTokens(bcnRaw);

                return records.filter(rec => {
                    const fieldValue = rec["im360_ingrambcn"];
                    const tokens = extractBCNTokens(fieldValue);
                    return tokens.some(t => validTokens.includes(t));
                });
            };
        </script>

        <style scoped>
            body {
                height: 100%;
                -moz-osx-font-smoothing: grayscale;
                -webkit-font-smoothing: antialiased;
                font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica Neue, Helvetica, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial, sans-serif;
            }

            .datagrid {
                margin: 10px 20px 10px 20px;
            }

            .dx-checkbox-container {
                height: 25px;
            }

            .min-col-bcn {
                min-width: 157px;
            }
        </style>

    </body>

</html>
