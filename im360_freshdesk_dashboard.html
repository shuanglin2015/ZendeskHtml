<!DOCTYPE html>
<html>

<head>
    <script src="ClientGlobalContext.js.aspx"></script>
    <script src="im360_common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/jquery@3.1.1/dist/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.2.0/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui@2.2.0/lib/index.js"></script>

    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/20.2.7/css/dx.common.css">
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/20.2.7/css/dx.light.css">
    <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/20.2.7/js/dx.web.js"></script>
</head>

    <body>
        <div id="app" class='datagrid'>
            <div v-if="showLoading" id="loading">
                <div id="loading-content">
                    <img src="im360_Loading.gif" />
                </div>
            </div>
            <div id="gridContainer"></div>
        </div>

        <script>
            let isStage = true;
            let zendeskBaseUrl = '';
            let funcCodeForJsonById = '';

            let app = new Vue({
                el: '#app',
                data: {
                    pageTitle: 'ZendeskDashboard',
                    showLoading: true,
                    freshdeskUrl: '',
                    // default appId value when Configuration FreshdeskAPI -> Value3 is not configured
                    appId: '80ffd75d-69ec-ea11-a817-000d3a8bdb91',
                    // default formId value when Configuration FreshdeskAPI -> Value4 is not configured
                    formId: 'c822d616-dce1-4671-a5ac-a9c3cadb5c2d',
                    startTime: Date.now(),
                    accountsData: []
                },
                async mounted() {
                    this.showLoadingPage();
                    this.startTime = Date.now();

                    let freshdeskConfig = await this.getFreshdeskConfig();
                    if (freshdeskConfig) {
                        let baseUrl = freshdeskConfig.im360_value;
                        this.zendeskBaseUrl = baseUrl;
                        console.log(`${this.pageTitle} - zendeskBaseUrl from FreshdeskAPI configuration: ${this.zendeskBaseUrl}`);
                        let funcCode = freshdeskConfig.im360_value2;
                        let funcCodeArr = funcCode.toString().split(';;;;');
                        let firstFuncCode = funcCodeArr[2];
                        this.freshdeskUrl = `${baseUrl}/searchByResellerId?code=${firstFuncCode}&resellerId=`;
                        this.funcCodeForJsonById = funcCodeArr[3];

                        let im360_value3 = freshdeskConfig.im360_value3;
                        if (im360_value3) {
                            this.appId = im360_value3;
                            console.log(`${this.pageTitle} - appId from FreshdeskAPI configuration: ${this.appId}`);
                        }

                        let im360_value4 = freshdeskConfig.im360_value4;
                        if (im360_value4) {
                            this.formId = im360_value4;
                            console.log(`${this.pageTitle} - formId from FreshdeskAPI configuration: ${this.formId}`);
                        }
                    } else {
                        console.error(`${this.pageTitle} - freshdeskConfig is null`);
                    }

                    if (this.freshdeskUrl) {
                        console.log(`${this.pageTitle} - freshdeskUrl: ${this.freshdeskUrl}`);

                        let stageApi = 'crm-zendesk-api.azurewebsites.net';
                        if (this.freshdeskUrl && this.freshdeskUrl.indexOf(stageApi) > -1) {
                            isStage = true;
                        } else {
                            isStage = false;
                        }

                        let zendeskCountryName = localStorage.getItem('zendesk_country_name');
                        let zendeskBCN = localStorage.getItem('zendesk_bcn');
                        console.log(`${this.pageTitle} - zendeskCountryName from localStorage: ${zendeskCountryName}`);
                        console.log(`${this.pageTitle} - zendeskBCN from localStorage: ${zendeskBCN}`);

                        /* let zendeskBCN = '20666904'; */
                        let tickets = await this.getTickets(zendeskCountryName, zendeskBCN);
                        console.log(`${this.pageTitle} - tickets: ${JSON.stringify(tickets)}`);
                        this.generateDatagrid(tickets); 
                    } else {
                        console.error(`${this.pageTitle} - Zendesk API URL is null`);
                    }

                },
                methods: {
                    async getFreshdeskConfig() {
                        let fetchXml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                         <entity name='im360_configuration'> \
                             <attribute name='im360_value'/> \
                             <attribute name='im360_value2'/> \
                             <attribute name='im360_value3'/> \
                             <attribute name='im360_value4'/> \
                             <filter type='and'> \
                                 <condition attribute='im360_name' operator='eq' value='FreshdeskAPI' /> \
                                 <condition attribute='statuscode' operator='eq' value='1' /> \
                             </filter> \
                         </entity> \
                         </fetch>";

                        let pageTitle = this.pageTitle;
                        return Xrm.WebApi.retrieveMultipleRecords("im360_configuration", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null) {
                                    return result.entities[0];
                                } else {
                                    console.error(`${pageTitle} - Cannot get Zendesk configuration.`);
                                    return null;
                                }
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                this.hideLoadingPage();
                                return null;
                            }
                        );
                    },

                    async getTickets(zendeskCountryName, zendeskBCN) {
                        let results = [];

                        let resellerCountry = zendeskCountryName ? zendeskCountryName : '';   // will get all tickets if resellerCountry is empty
                        let resellerId = zendeskBCN ? zendeskBCN : '0';                       // will get all tickets if resellerId is 0
                        console.log(`${this.pageTitle} - resellerCountry: ${resellerCountry}`);  
                        console.log(`${this.pageTitle} - resellerId: ${resellerId}`);  

                        let response;
                        try {
                            let fullUrl = `${this.freshdeskUrl}${resellerId}`;
                            console.log(fullUrl);
                            response = await axios.get(fullUrl);
                        } catch (err) {
                            console.error(`${this.pageTitle} - Zendesk API error`);
                        }

                        if (response && response.data) {
                            let itemsWithoutCountryFilter = response.data.results;
                            if (zendeskCountryName) {
                                let itemsWithCountryFilter = [];
                                await asyncForEach(itemsWithoutCountryFilter, async ticket => {
                                    let countryFieldId = isStage ? 31959436739604 : 35138178531732;
                                    const objCountry = ticket.custom_fields && ticket.custom_fields.find(item => item.id === countryFieldId);
                                    const countryValue = objCountry ? objCountry.value : '';
                                    let strCountry = countryValue ? await this.getCustomFieldValue(countryFieldId, countryValue) : '-';
                                    if (strCountry && zendeskCountryName && (strCountry.toLowerCase().trim() == zendeskCountryName.toLowerCase().trim())) {
                                        ticket.strCountry = strCountry;
                                        itemsWithCountryFilter.push(ticket);
                                    }
                                });
                                items = itemsWithCountryFilter;
                            } else {
                                items = itemsWithoutCountryFilter;
                            }

                            await asyncForEach(items, async result => {
                                if (result && result.id && result.subject) {
                                    if (!result.strCountry) {
                                        let countryFieldId = isStage ? 31959436739604 : 35138178531732;
                                        const objCountry = result.custom_fields && result.custom_fields.find(item => item.id === countryFieldId);
                                        const countryValue = objCountry ? objCountry.value : '';
                                        result.strCountry = countryValue ? await this.getCustomFieldValue(countryFieldId, countryValue) : '';
                                    }

                                    let bcnFieldId = isStage ? 21077919616660 : 9213900294676;
                                    const objBCN = result.custom_fields && result.custom_fields.find(item => item.id === bcnFieldId);
                                    const bcnValue = objBCN ? objBCN.value : '';
                                    result.strBCN = bcnValue ? await this.getCustomFieldValue(bcnFieldId, bcnValue) : '-';

                                    let jsonPath = 'users';
                                    let jsonId = result.requester_id;
                                    let userData = jsonId ? await this.getJsonById(this.zendeskBaseUrl, jsonPath, jsonId, this.funcCodeForJsonById) : '';
                                    result.requesterEmail = userData.user ? userData.user.email : '-';
                                    result.requesterName = userData.user ? userData.user.name : '-';

                                    let domainFieldId = isStage ? 31042462931476 : 34698829065236;
                                    const objDomain = result.custom_fields && result.custom_fields.find(item => item.id === domainFieldId);
                                    const domainValue = objDomain ? objDomain.value : '';
                                    result.strDomain = domainValue? await this.getCustomFieldValue(domainFieldId, domainValue) : '-';

                                    let accountData = await this.getAccountIdByCountryAndBCN(result.strCountry, result.strBCN);
                                    result.strAccountId = accountData ? accountData.accountid : '-';
                                }
                            });

                            if (items && items.length > 0) {
                                items.forEach(item => {
                                    if (item && item.id && item.subject && Object.keys(item).length > 0) {
                                        let itemNew = {
                                            'TicketId': item.id,
                                            'Country': item.strCountry ? item.strCountry : '-',
                                            'Ingram BCN#': item.strBCN ? item.strBCN : '-',
                                            'Partner email address': item.requesterEmail ? item.requesterEmail : '-',
                                            'Reseller Name': item.requesterName ? item.requesterName : '-',
                                            'Ticket subject line': item.subject ? item.subject : '-',
                                            'Status': item.status ? item.status.charAt(0).toUpperCase() + item.status.slice(1) : '-',
                                            'Domain': item.strDomain ? item.strDomain : '-',
                                            'Priority': item.priority ? item.priority.charAt(0).toUpperCase() + item.priority.slice(1) : '-',
                                            'AccountId': item.strAccountId ? item.strAccountId : '-'
                                        };

                                        console.log(`${this.pageTitle} - item after adding more fields: ${JSON.stringify(itemNew)}`);
                                        results.push(itemNew);
                                    }
                                });
                            } 
                        } else {
                            console.error(`${this.pageTitle} - Get Zendesk tickets error`);
                        }
                        this.hideLoadingPage();
                        return results;
                    },

                    async getCustomFieldValue(fieldId, fieldValue) {
                        let result = fieldValue;
                        let jsonId = fieldId;
                        let jsonPath = 'ticket_fields/';
                        let fieldData = fieldId ? await this.getJsonById(this.zendeskBaseUrl, jsonPath, jsonId, this.funcCodeForJsonById) : '';
                        if (fieldData == '-') {
                            result = fieldData;
                        } else {
                            if (fieldData && fieldData.ticket_field && fieldData.ticket_field.custom_field_options) {
                                const obj = fieldData.ticket_field.custom_field_options.find(item => item.value === fieldValue);
                                result = obj ? obj.name : fieldValue;
                            }
                        }
                        return result ? result : '-';
                    },

                    async getJsonById(zendeskBaseUrl, jsonPath, jsonId, funcCodeForJsonById) {
                        let result = '-';
                        if (jsonId && jsonId !== 'null') {
                            try {
                                const response = await axios.get(`${zendeskBaseUrl}/getJsonById?jsonPath=${jsonPath}&jsonId=${jsonId}&code=${funcCodeForJsonById}`);
                                result = response.data ? response.data : '';
                            } catch (e) {
                                console.error(`${this.pageTitle} - getJsonById error for jsonId ${jsonId}: ${e.message}`);
                                result = `[API Error for jsonPath ${jsonPath} and jsonId ${jsonId}]`;
                            }
                        }
                        return result;
                    },

                    async getAccountIdByCountryAndBCN(strCountry, strBCN) {
                        let fetchXml = `<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'> \
                                            <entity name='account'> \
                                                <attribute name='accountid' /> \
                                                <attribute name='im360_bcn' /> \
                                                <link-entity name='im360_country' from='im360_countryid' to='im360_country' link-type='inner'> \
                                                    <attribute name='im360_name' alias='CountryName' /> \
                                                    <filter type='and'> \
                                                        <condition attribute='im360_name' operator='eq' value='${strCountry}' /> \
                                                    </filter> \
                                                </link-entity> \
                                                <filter type='and'> \
                                                    <condition attribute='im360_bcn' operator='eq' value='${strBCN}' /> \
                                                </filter> \
                                            </entity> \
                                        </fetch>`;

                        let pageTitle = this.pageTitle;
                        return Xrm.WebApi.retrieveMultipleRecords("account", "?fetchXml=" + fetchXml).then(
                            function success(result) {
                                if (result != null) {
                                    return result.entities[0];
                                } else {
                                    console.error(`${pageTitle} - Cannot get AccountId by Country and BCN.`);
                                    return null;
                                }
                            },
                            function (error) {
                                console.error(`${pageTitle} - ${error.message}`);
                                this.hideLoadingPage();
                                return null;
                            }
                        );
                    },

                    generateDatagrid(ticketsArr) {
                        let pageTitle = this.pageTitle;
                        let appId = this.appId;
                        let formId = this.formId;

                        $("#gridContainer").dxDataGrid({
                            dataSource: ticketsArr,
                            remoteOperations: false,
                            allowColumnReordering: true,
                            rowAlternationEnabled: true,
                            allowColumnResizing: true,
                            columnAutoWidth: true,
                            columnChooser: { enabled: true },
                            columnFixing: { enabled: true },
                            filterRow: { visible: true },
                            headerFilter: { visible: true },
                            editing: { mode: `form`, allowUpdating: false, allowEditing: false, allowAdding: false, allowDeleting: false },
                            export: { enabled: true, fileName: `item` },
                            grouping: { contextMenuEnabled: true },
                            groupPanel: { visible: true },
                            hoverStateEnabled: true,
                            loadPanel: { height: 100, width: 200, text: `Loading Data...` },
                            pager: { showInfo: true, infoText: `Page {0}. Total: {1} ({2} items)`, showPageSizeSelector: true, allowedPageSizes: [5, 15, 30] },
                            paging: { pageSize: 15, pageIndex: 0 },
                            searchPanel: { visible: true, width: 240, placeholder: `Search...` },
                            selection: { mode: `single` },
                            sorting: { mode: `multiple` },
                            showBorders: true,
                            showColumnLines: true,
                            showRowLines: true,
                            showScrollbar: true,
                            useNative: false,
                            onSelectionChanged: function (selectedItems) {
                                let data = selectedItems.selectedRowsData[0];
                                console.log(`${pageTitle} - onSelectionChanged -> data: ${JSON.stringify(data)}`);
                                /*let accountId = '8e70a94a-9a02-e911-a961-000d3a30e34c';*/
                                let accountId = data.AccountId;
                                let ticketId = data.TicketId;
                                let url = window.location.protocol + "//" + window.location.host + "/";
                                let fieldName = 'im360_newnavigationtab';
                                let tabName = 'tab_freshdesk';    
                                let selectedResellerId = data['Ingram BCN#'];
                                let fullUrl = `${url}/main.aspx?appid=${appId}&forceUCI=1&pagetype=entityrecord&etn=account&id=${accountId}&formid=${formId}&extraqs=${fieldName}%3D${tabName}_${ticketId}_${selectedResellerId}`;
                                console.log(`${pageTitle} - fullUrl: ${fullUrl}`);
                                window.open(fullUrl, '_blank');
                                return null;
                            }
                        });
                        this.hideLoadingPage();
                    },

                    showLoadingPage() {
                        this.showLoading = true;
                    },

                    hideLoadingPage() {
                        try {
                            setTimeout(() => {
                                this.showLoading = false;
                            }, 1000);
                        } catch (ex) {
                            this.showLoading = false;
                        }
                    }
                }
                
            });

            const asyncForEach = async (array, callback) => {
                if (array && callback) {
                    for (let index = 0; index < array.length; index++) {
                        await callback(array[index], index, array);
                    }
                }
            }
        </script>


        <style scoped>
            body {
                height: 100%;
                -moz-osx-font-smoothing: grayscale;
                -webkit-font-smoothing: antialiased;
                font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica Neue, Helvetica, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial, sans-serif;
            }

            /* loading image */
            #loading {
                width: 100%;
                height: 100%;
                top: 0px;
                left: 0px;
                position: fixed;
                display: block;
                opacity: 0.85;
                background-color: #fff;
                z-index: 99;
                text-align: center;
            }

            #loading-content {
                position: absolute;
                top: 30%;
                left: 45%;
                text-align: center;
                z-index: 100;
            }

            .datagrid {
                margin: 10px 20px 10px 20px;
            }

            .dx-checkbox-container {
                height: 25px;
            }
        </style>

    </body>

</html>
